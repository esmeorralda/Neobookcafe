<head>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-kopub@1.0/kopubbatang.min.css">
  <meta name="csrf-token" content="<%= form_authenticity_token %>" />
  <style>
    #post-container.grid-active {
      display: flex;
      gap: 2rem;
      max-width: 100vw;
      padding: 0 2rem;
      box-sizing: border-box;
      justify-content: space-between;
      align-items: flex-start;
    }

    #left-column {
      flex-grow: 1;
      min-width: 500px;
      max-width: calc(100vw - 440px);
    }
#comment-sidebar {
  flex-shrink: 0;
  width: 500px;          /* ê¸°ì¡´ 400pxì—ì„œ ë„“í˜ */
  max-height: 95vh;      /* ê¸°ì¡´ 90vhì—ì„œ ì¢€ ë” ì„¸ë¡œë¡œ ê¸¸ê²Œ */
  overflow-y: auto;
  background-color: #f9f6f2;
  border-left: 1px solid #d1d5db;
  padding: 1rem;
  border-radius: 0 8px 8px 0;
  position: sticky;
  top: 3rem;             /* ìƒë‹¨ ì—¬ìœ ë„ ì•½ê°„ ì¡°ì ˆ ê°€ëŠ¥ */
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
}

    .hidden {
      display: none !important;
    }

    /* ì „ì²´ ëŒ“ê¸€ ì…ë ¥ í¼ ì»¨í…Œì´ë„ˆ */
    #root-comment-form {
      margin-top: 3rem;
    }

   .comment-highlight {
  border: 1px solid #e5e7eb; /* Tailwindì˜ border-gray-200 */
  border-radius: 0.75rem;    /* rounded-xl */
  padding: 0.75rem;          /* p-3 */
  background-color: #ffffff; /* í° ë°°ê²½ */
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.06); /* soft shadow */
   border-color 0.25s ease;
}



    /* ì „ì²´ ëŒ“ê¸€ í¼ textarea */
    #root-comment-form textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1c4b2;
      border-radius: 6px;
      resize: vertical;
      font-size: 0.9rem;
      font-family: inherit;
      box-sizing: border-box;
    }

    .reply-form textarea {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #d1c4b2;
  border-radius: 6px;
  resize: vertical; /* ì„¸ë¡œë¡œ ë¦¬ì‚¬ì´ì§• ê°€ëŠ¥ */
  font-size: 0.9rem;
  font-family: inherit;
  box-sizing: border-box;
  min-height: 2.5rem; /* rows=3 ì •ë„ ë†’ì´ */
  margin-bottom: 0.5rem;
  transition: border-color 0.3s ease;
}


/* ë¸”ë¡ë³„ ëŒ“ê¸€ textarea */
.hidden-comment-forms textarea {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #d1c4b2;
  border-radius: 6px;
  resize: vertical;
  font-size: 0.9rem;
  font-family: inherit;
  box-sizing: border-box;
  min-height: 6rem;
  margin-bottom: 0.5rem;
  transition: border-color 0.3s ease;
  height: auto; /* ìë™ ë†’ì´ ì¡°ì ˆ */

}



    /* ì „ì²´ ëŒ“ê¸€ í¼ ë²„íŠ¼ */
    #root-comment-form button[type="submit"] {
      margin-top: 0.5rem;

      color: white;
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    #root-comment-form button[type="submit"]:hover {
      background-color: #a5774e;
    }

    /* ëŒ“ê¸€ ë³´ê¸° ë²„íŠ¼ */
    .comment-view-btn {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .comment-view-btn:hover {
      background-color: #f0eadf;
    }

    /* ëŒ“ê¸€ ì‚¬ì´ë“œë°” ë‚´ë¶€ ì œëª© & ë‹«ê¸° ë²„íŠ¼ */
    #comment-sidebar > div:first-child {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    #close-comment-sidebar {
      font-size: 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
      transition: color 0.2s ease;
    }
    #close-comment-sidebar:hover {
      color: #333;
    }

    /* ëŒ“ê¸€ ëª©ë¡ ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì˜ì—­ */
    #comment-sidebar-content {
      overflow-y: auto;
      flex-grow: 1;
      min-height: 200px;
      border: none;

    }

    /* ëŒ“ê¸€ í¼ textarea ì‚¬ì´ë“œë°” ì•ˆ */
    #comment-sidebar-content textarea {
      width: 100%;
      padding: 0.5rem;
      resize: vertical;
      font-size: 0.9rem;
      font-family: inherit;
      box-sizing: border-box;
      margin-bottom: 0.5rem;
    }

    /* ëŒ“ê¸€ í¼ ë²„íŠ¼ ì‚¬ì´ë“œë°” ì•ˆ */
    #comment-sidebar-content button[type="submit"] {
      color: white;
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    
  </style>
</head>

<body><div class="mx-auto min-h-screen py-10 px-4 font-serif">
  <!-- ë³¸ë¬¸ + ëŒ“ê¸€ ì‚¬ì´ë“œë°” ì»¨í…Œì´ë„ˆ -->
  <div id="post-container" class="max-w-4xl mx-auto relative">


   <div class="flex justify-end space-x-2 mt-3">
  <% if user_signed_in? && @post.user_id == current_user.id %>
  <button 
      id="copy-link-btn"
      data-url="<%= post_url(@post) %>" 
      class="border border-gray-300 bg-white px-3 py-1 text-sm hover:bg-gray-100"
    >
      ê³µìœ í•˜ê¸°
    </button>
    <%= link_to "í¸ì§‘", edit_post_path(@post), class: " bg-[#b88b65] text-white px-3 py-1 text-sm" %>
    <%= button_to post_path(@post), method: :delete,
          data: { confirm: "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" },
          class: "border border-gray-300 bg-white px-3 py-1 text-sm" do %>
      ì‚­ì œ
    <% end %>
  <% elsif user_signed_in? && current_user.bookmarked_posts.exists?(@post.id) %>
    <%= button_to post_unbookmark_path(@post), method: :delete, class: "flex items-center" do %>
      <%= image_tag "icon/post/Vector 41.svg", class: "w-4 h-6 fill-current text-[#2c1a0d]" %>
    <% end %>
  <% elsif user_signed_in? %>
    <%= button_to post_bookmark_path(@post), method: :post, class: "flex items-center" do %>
      <%= image_tag "icon/post/Vector 40.svg", class: "w-4 h-6 fill-current text-gray-400" %>
    <% end %>
  <% end %>
</div>

    <!-- ì™¼ìª½ ì»¬ëŸ¼ : ì œëª©, ë©”íƒ€ì •ë³´, ë³¸ë¬¸ -->
    <div id="left-column" class="space-y-6 text-gray-800">
      <!-- ì œëª© / ë©”íƒ€ ì •ë³´ -->
      <div>
        <h1 class="text-3xl font-semibold text-[#2c1a0d] mb-2"><%= @post.title %></h1>
        <p class="text-sm text-gray-700 mb-2">
          ì±… ì œëª© <%= @post.book_title %> (<%= @post.book_author %>)
        </p>
        <p class="text-sm text-gray-500 mb-4">
          <%= @post.user.name %> ì”€, <%= @post.created_at.strftime('%Yë…„ %-mì›” %-dì¼') %>
        </p>
       <% if @post.draft %>
  <p class="text-sm  space-x-6 mb-6">ì´ ê¸€ì€ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤.</p>
<% else %>
  <div class="flex items-center space-x-6 mb-6">
    <div class="flex items-center space-x-1">
      <%= image_tag "icon/post/viewCount.svg", class: "w-4 h-4", alt: "ì¡°íšŒìˆ˜" %>
      <span class="text-xs"><%= @post.view_count.to_i %>íšŒ</span>
    </div>
    <div class="flex items-center space-x-1">
      <%= image_tag "icon/post/comments.svg", class: "w-4 h-4", alt: "ëŒ“ê¸€" %>
      <span class="text-xs"><%= total_comments_count(@post) %>ê°œ</span>
    </div>
    <div class="flex items-center space-x-1">
      <%= image_tag "icon/post/likes.svg", class: "w-4 h-4", alt: "ì¢‹ì•„ìš”" %>
      <span class="text-xs"><%= @post.like_count.to_i %>ê°œ</span>
    </div>
  </div>
<% end %>


        <hr class="border-t border-[#e3d5c6]" />
      </div>

      <!-- ë³¸ë¬¸ ì˜ì—­ -->
      <div id="post-content" class="space-y-6 text-base leading-relaxed">
        <% @post.post_blocks.order(:position).each do |block| %>
          <div class="relative flex items-start" id="post-block-wrapper-<%= block.id %>">
            <div class="flex-1">
              <% case block.block_type %>
              <% when 'paragraph' %>
                <p id="post-block-<%= block.id %>" data-block-id="<%= block.id %>"><%= raw(block.content.gsub(/\r?\n/, '<br>')) %></p>
              <% when 'subtitle' %>
                <h2 id="post-block-<%= block.id %>" data-block-id="<%= block.id %>" class="text-lg font-semibold text-[#2c1a0d]">
                  <%= block.content %>
                </h2>
              <% when 'quote' %>
                <blockquote id="post-block-<%= block.id %>" data-block-id="<%= block.id %>" class="pl-4 border-l-4 border-[#2c1a0d] italic text-[#2c1a0d]">
                  â€œ<%= block.content %>â€
                </blockquote>
              <% else %>
                <p id="post-block-<%= block.id %>" data-block-id="<%= block.id %>"><%= simple_format(block.content) %></p>
              <% end %>
            </div>

            <% if block.block_type != 'quote' && @post.draft !=true%>
              <div class="ml-3 flex-shrink-0">
                <button type="button"
                  class="text-xs px-2 py-1 border border-gray-300 rounded text-gray-600 hover:bg-gray-100 comment-view-btn"
                  data-block-id="<%= block.id %>">
                  ëŒ“ê¸€ ë³´ê¸°
                </button>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- ì¢‹ì•„ìš” ë²„íŠ¼: ëŒ“ê¸€ ì…ë ¥ì°½ ìœ„ë¡œ ì´ë™ -->
      <% if user_signed_in? && @post.draft == false%>
        <div class="flex items-center justify-between mt-12 mb-4">
          <div>
            <% likeable = @post %>
            <% liked = likeable.likes.exists?(user: current_user) %>
            <%= form_with(
              url: liked ? like_path(likeable.likes.find_by(user: current_user)) : likes_path,
              method: liked ? :delete : :post,
              remote: true,
              html: { id: dom_id(likeable, :like_button), class: "like-form" },
              data: { disable_with: "ì²˜ë¦¬ ì¤‘..." }
            ) do |f| %>
              <%= hidden_field_tag :likeable_type, likeable.class.name %>
              <%= hidden_field_tag :likeable_id, likeable.id %>

              <button type="submit" class="flex items-center space-x-1 focus:outline-none">
                <% if liked %>
                  <%= image_tag "icon/post/filledheart.svg", class: "w-4 h-4" %>
                <% else %>
                  <%= image_tag "icon/post/emptyheart.svg", class: "w-4 h-4" %>
                <% end %>
                <span class="text-xs"><%= likeable.likes.count %></span>
              </button>
            <% end %>
          </div>
        </div>
      <% end %>

  <hr class="border-t border-[#e3d5c6]" />
      <!-- âœ… ì „ì²´ ëŒ“ê¸€ ì‘ì„± í¼ (ë£¨íŠ¸ ëŒ“ê¸€) ë³¸ë¬¸ ë°”ë¡œ ì•„ë˜ -->
 <%= form_with model: Comment.new, url: post_comments_path(@post), local: true do |f| %>
  <%= f.hidden_field :post_block_id, value: nil %>
  <%= f.hidden_field :post_id, value: @post.id %>

  <% if @post.draft != true %>
   
  <div class="flex flex-col space-y-1">
    <%= f.text_area :content, placeholder: "ë‹µê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”", rows: 4, class: "auto-resize-textarea w-full p-2 border border-[#d1c4b2] rounded text-sm resize-none focus:outline-none focus:ring-1 focus:ring-[#b88b65]" %>

    <div class="flex justify-end mt-2">
      <button type="submit" class="bg-[#5d3b2e] text-white px-4 py-1 rounded text-sm cursor-pointer">
        ëŒ“ê¸€ ë“±ë¡
      </button>
    </div>
  </div>
  <% end %>
<% end %>



  <% if @post.draft != true %>
<div id="root-comment-list" class="mt-6 max-h-[600px] overflow-y-auto bg-[#f9f6f2] p-4 rounded-lg shadow-inner">

  <!-- ëŒ“ê¸€ ì •ë ¬ ë“œë¡­ë‹¤ìš´ -->
  <div class="mb-4 flex items-center space-x-2">
    <label for="sort-comments" class="text-sm font-medium text-gray-700">ëŒ“ê¸€ ì •ë ¬:</label>
    <select id="sort-comments" name="sort" class="border rounded px-2 py-1 text-sm" onchange="location = this.value;">
      <option value="<%= url_for(params.permit(:id).merge(sort: 'latest')) %>" <%= 'selected' if params[:sort] == 'latest' || params[:sort].blank? %>>ìµœì‹ ìˆœ</option>
      <option value="<%= url_for(params.permit(:id).merge(sort: 'oldest')) %>" <%= 'selected' if params[:sort] == 'oldest' %>>ì˜¤ë˜ëœ ìˆœ</option>
      <option value="<%= url_for(params.permit(:id).merge(sort: 'likes')) %>" <%= 'selected' if params[:sort] == 'likes' %>>ì¢‹ì•„ìš” ìˆœ</option>
    </select>
  </div>

  <%# ì •ë ¬ ì²˜ë¦¬: params[:sort] ê¸°ì¤€ìœ¼ë¡œ @commentsë¥¼ ë·°ì—ì„œ ì •ë ¬ %>
  <%
    sorted_comments = case params[:sort]
    when 'oldest'
      @comments.sort_by(&:created_at)
    when 'likes'
      @comments.sort_by { |c| -c.likes.count }
    else
      @comments.sort_by(&:created_at).reverse
    end
  %>

<!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
<!-- ëŒ“ê¸€ ëª©ë¡ -->
<!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
<div class="space-y-4">
  <% @comments.where(parent_id: nil).each do |comment| %>
    <div class="comment  rounded-md p-4 bg-white shadow-sm" data-comment-id="<%= comment.id %>">
      
      <!-- ìœ ì € ì´ë¦„ + ë‚ ì§œ + ì¢‹ì•„ìš” + ë²„íŠ¼ -->
      <div class="flex justify-between items-start">
        <div>
          <p class="text-sm font-semibold text-gray-800"><%= comment.user.name %></p>
        </div>
        <div class="flex items-center space-x-2">
          <p class="text-xs text-gray-400"><%= comment.created_at.strftime('%Yë…„ %-mì›” %-dì¼ %H:%M') %></p>
          <%= render partial: 'comment_like', locals: { likeable: comment }  %>

          <% if user_signed_in? && comment.user_id == current_user.id %>
            <button class="edit-comment-button text-xs text-black hover:underline" data-comment-id="<%= comment.id %>">í¸ì§‘</button>
            <%= link_to 'ì‚­ì œ', comment_path(comment), method: :delete, data: { confirm: 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' }, class: 'text-xs text-red-500 hover:underline' %>
          <% end %>
        </div>
      </div>

      <!-- ëŒ“ê¸€ ë³¸ë¬¸ -->
      <div class="comment-content text-sm text-gray-700 mt-1">
        <%= comment.content %>
      </div>

      <!-- ë‹µê¸€ í† ê¸€ -->
      <button class="mt-2 text-xs text-[#b88b65] hover:text-[#a5774e] reply-toggle" data-comment-id="<%= comment.id %>">
        <% if comment.children.any? %>
          ğŸ’¬ <%= comment.children.count %>ê°œì˜ ë‹µê¸€ ë³´ê¸°
        <% else %>
          ë‹µê¸€ ë‹¬ê¸°
        <% end %>
      </button>

      <!-- ëŒ€ëŒ“ê¸€ ì»¨í…Œì´ë„ˆ -->
      <div class="ml-4 mt-3 space-y-2 hidden reply-container" id="reply-container-<%= comment.id %>">
        <% comment.children.order(created_at: :asc).each do |reply| %>
          <div class="comment rounded-md p-4 bg-[#f9f6f2] shadow-sm" data-comment-id="<%= reply.id %>">
            
            <!-- ìœ ì € ì´ë¦„ + ë‚ ì§œ + ì¢‹ì•„ìš” + ë²„íŠ¼ -->
            <div class="flex justify-between items-start">
              <div>
                <p class="text-sm font-semibold text-gray-800"><%= reply.user.name %></p>
               
              </div>
              <div class="flex items-center space-x-2">
                <p class="text-xs text-gray-400"><%= reply.created_at.strftime('%Yë…„ %-mì›” %-dì¼ %H:%M') %></p>
                <%= render partial: 'comment_like', locals: { likeable: reply }  %>
                
                <% if user_signed_in? && reply.user_id == current_user.id %>
                  <button class="edit-comment-button text-xs text-black hover:underline" data-comment-id="<%= reply.id %>">í¸ì§‘</button>
                  <%= link_to 'ì‚­ì œ', comment_path(reply), method: :delete, data: { confirm: 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' }, class: 'text-xs text-red-500 hover:underline' %>
                <% end %>
              </div>
            </div>

            <!-- ë³¸ë¬¸ -->
            <div class="comment-content text-sm text-gray-700 mt-1">
              <%= reply.content %>
            </div>
          </div>
        <% end %>

        <!-- ëŒ€ëŒ“ê¸€ ì‘ì„± í¼ -->
        <% if user_signed_in? %>
          <%= form_with model: Comment.new, url: post_comments_path(@post), local: false, html: { class: "reply-form" } do |f| %>
            <%= f.hidden_field :parent_id, value: comment.id %>
            <%= f.hidden_field :post_id, value: @post.id %>
            <%= f.text_area :content, rows: 1, placeholder: "ëŒ€ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”",rows: 2,class: "auto-resize-textarea w-full p-2 border border-[#d1c4b2] rounded text-sm focus:outline-none focus:ring-1 focus:ring-[#b88b65]" %>
            <div class="flex justify-end mt-1 ">
              <%= f.submit "ë‹µê¸€ ë“±ë¡", class: "px-3 py-1 bg-[#5d3b2e] text-white rounded text-xs cursor-pointer" %>
            </div>
          <% end %>
        <% end %>
      </div>

    </div>
  <% end %>
</div>
 
</div>
  <% end %>


    </div>

    <!-- ì˜¤ë¥¸ìª½ ì»¬ëŸ¼ : ëŒ“ê¸€ ì‚¬ì´ë“œë°” -->
    <div id="comment-sidebar" class="hidden">
      <div>
        <h3 class="font-semibold text-lg">ëŒ“ê¸€</h3>
        <button id="close-comment-sidebar" aria-label="ëŒ“ê¸€ ì‚¬ì´ë“œë°” ë‹«ê¸°">&times;</button>
      </div>
      <div id="comment-sidebar-content" class="text-sm text-gray-700">
        <!-- JSë¡œ ëŒ“ê¸€ ë° í¼ì„ ë¡œë“œ -->
      </div>
    </div>
  </div>

  <!-- ìˆ¨ê²¨ì§„ ëŒ“ê¸€ í¼ë“¤ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
  <div id="hidden-comment-forms" class="hidden">
    <% @post.post_blocks.order(:position).each do |block| %>
      <div id="comment-form-<%= block.id %>" class="hidden mt-2 mb-10 rounded p-4 bg-[#f9f6f2]">
        <% comments = Comment.where(post_block_id: block.id).order(created_at: :asc) %>
       <% if comments.any? %>
 <div class="space-y-3 overflow-y-auto pb-3" style="max-height: 500px;">
  <% comments.each do |comment| %>
    <div class="comment border-b border-[#d1c4b2] pb-2 mb-2 ">
      
      <!-- ìƒë‹¨: ìœ ì €ì´ë¦„ / ë‚ ì§œ + í•˜íŠ¸ -->
      <div class="flex justify-between items-start">
        <p class="font-semibold text-gray-800 text-sm"><%= comment.user.name %></p>

        <div class="flex items-center space-x-2">
          <p class="text-xs text-gray-500"><%= comment.created_at.strftime('%Yë…„ %-mì›” %-dì¼ %H:%M') %></p>
          <%= render partial: 'comment_like', locals: { likeable: comment }  %>

  <div class="flex items-center space-x-2" style="line-height: 1.25; font-size: 0.75rem;">
  <%= button_tag 'í¸ì§‘',
    type: 'button',
    class: 'edit-comment-button text-xs hover:underline',
    data: { comment_id: comment.id } %>

   <%= link_to 'ì‚­ì œ', comment_path(comment), method: :delete, data: { confirm: 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?' }, class: 'text-xs text-red-500 hover:underline' %>
</div>

        </div>
      </div>

      <!-- ë³¸ë¬¸ -->
    <p class="comment-content text-sm mt-2 text-gray-700 "><%= comment.content %></p>

    </div>
  <% end %>
</div>

        <% else %>
          <p class="text-gray-500 text-sm italic mt-2">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <% end %>

     <%= form_with model: Comment.new, url: post_comments_path(@post), local: true , html: { id: "hidden-comment-forms" } do |f| %>

  <%= f.hidden_field :post_block_id, value: block.id %>
  <%= f.hidden_field :post_id, value: @post.id %>
<div class="mb-1 comment-content  ">
  <%= f.text_area :content, placeholder: "ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”", rows: 3, style: "min-height: 6rem;", class: "auto-resize-textarea w-full p-2 border border-[#d1c4b2] rounded text-sm focus:outline-none focus:ring-1 focus:ring-[#b88b65]" %>

</div>

<div class="flex justify-end mt-0">  <button type="submit" class="px-4 py-2 bg-[#5d3b2e] text-white rounded text-sm">
    ëŒ“ê¸€ ë“±ë¡
  </button>
</div>

<% end %>


      </div>
    <% end %>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const postContainer = document.getElementById('post-container');
  const commentSidebar = document.getElementById('comment-sidebar');
  const commentSidebarContent = document.getElementById('comment-sidebar-content');
  const closeBtn = document.getElementById('close-comment-sidebar');

  // ë¸”ë¡ë³„ ëŒ“ê¸€ ë³´ê¸° ë²„íŠ¼ í´ë¦­
  document.querySelectorAll('.comment-view-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const blockId = btn.getAttribute('data-block-id');
      const isOpen = !commentSidebar.classList.contains('hidden');
      const wrapperSelector = `#post-block-wrapper-${blockId}`;
      const currentBlockWrapper = document.querySelector(wrapperSelector);

      if (isOpen && btn.classList.contains('active')) {
        commentSidebar.classList.add('hidden');
        postContainer.classList.remove('grid-active');
        commentSidebarContent.innerHTML = '';

        document.querySelectorAll('.comment-view-btn').forEach(b => {
          b.textContent = 'ëŒ“ê¸€ ë³´ê¸°';
          b.classList.remove('active');
        });

        document.querySelectorAll('[id^="post-block-wrapper-"]').forEach(wrapper => {
          wrapper.classList.remove('comment-highlight');
        });
      } else {
        document.querySelectorAll('.comment-view-btn').forEach(b => {
          b.textContent = 'ëŒ“ê¸€ ë³´ê¸°';
          b.classList.remove('active');
        });

        document.querySelectorAll('[id^="post-block-wrapper-"]').forEach(wrapper => {
          wrapper.classList.remove('comment-highlight');
        });

        commentSidebar.classList.remove('hidden');
        postContainer.classList.add('grid-active');
        btn.textContent = 'ëŒ“ê¸€ ë‹«ê¸°';
        btn.classList.add('active');
        currentBlockWrapper?.classList.add('comment-highlight');

        loadComments(blockId);
      }
    });
  });

  closeBtn.addEventListener('click', () => {
    commentSidebar.classList.add('hidden');
    postContainer.classList.remove('grid-active');
    commentSidebarContent.innerHTML = '';

    document.querySelectorAll('.comment-view-btn').forEach(btn => {
      btn.textContent = 'ëŒ“ê¸€ ë³´ê¸°';
      btn.classList.remove('active');
    });

    document.querySelectorAll('[id^="post-block-wrapper-"]').forEach(wrapper => {
      wrapper.classList.remove('comment-highlight');
    });
  });

  function loadComments(blockId) {
    const commentForm = document.getElementById(`comment-form-${blockId}`);
    if (!commentForm) {
      commentSidebarContent.innerHTML = '<p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    commentSidebarContent.innerHTML = '';
    const clone = commentForm.cloneNode(true);
    clone.classList.remove('hidden');
    commentSidebarContent.appendChild(clone);

    // ëŒ“ê¸€ í¼ ì œì¶œ
    const form = clone.querySelector('form');
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const token = document.querySelector('meta[name="csrf-token"]').content;

      fetch(form.action, {
        method: form.method.toUpperCase(),
        headers: {
          'Accept': 'application/json',
          'X-CSRF-Token': token
        },
        body: formData
      })
      .then(async (response) => {
        if (!response.ok) {
          const errorData = await response.json();
          const errors = errorData.errors || ['ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨'];
          throw new Error(errors.join(', '));
        }
        return response.json();
      })
      .then(data => {
        alert('ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.reload();
      })
      .catch(error => alert(`ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`));
    });

    // âœ¨ í¸ì§‘ ë²„íŠ¼ ì¬ë°”ì¸ë”©
    bindEditCommentButtons(clone);
  }

  // í¸ì§‘ ê¸°ëŠ¥ ì •ì˜
function bindEditCommentButtons(scope = document) {
  scope.querySelectorAll('.edit-comment-button').forEach(button => {
    button.addEventListener('click', () => {
      const commentEl = button.closest('.comment');
      const contentEl = commentEl.querySelector('.comment-content');
      const originalText = contentEl.textContent.trim();
      const commentId = commentEl.dataset.commentId;

      // textarea ìƒì„± ë° ìŠ¤íƒ€ì¼ ì ìš©
      const textarea = document.createElement('textarea');
      textarea.className = 'edit-comment-textarea auto-resize-textarea w-full p-2 border border-[#d1c4b2] rounded text-sm resize-none focus:outline-none focus:ring-1 focus:ring-[#b88b65] mt-2';
      textarea.value = originalText;
      contentEl.replaceWith(textarea);

      // textarea ìë™ ë¦¬ì‚¬ì´ì¦ˆ ì¦‰ì‹œ ì ìš©
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';

      textarea.addEventListener('input', () => {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      });

      // í¸ì§‘ ë²„íŠ¼ â†’ ì—…ë°ì´íŠ¸ë¡œ ë³€ê²½
      button.textContent = 'ì—…ë°ì´íŠ¸';
      button.classList.remove('edit-comment-button');
      button.classList.add('update-comment-button');

      // ì‚­ì œ ë²„íŠ¼ â†’ ì·¨ì†Œ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
      const deleteButton = commentEl.querySelector('a.text-red-500');
      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'ì·¨ì†Œ';
      cancelButton.className = 'cancel-edit-button text-xs text-gray-500 hover:underline ml-2';
      deleteButton.replaceWith(cancelButton);

      // ì·¨ì†Œ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë³µì›
      cancelButton.addEventListener('click', () => {
        const restoredContent = document.createElement('p');
        restoredContent.className = 'comment-content text-sm mt-2 text-gray-700 px-4';
        restoredContent.textContent = originalText;
        textarea.replaceWith(restoredContent);

        button.textContent = 'í¸ì§‘';
        button.classList.remove('update-comment-button');
        button.classList.add('edit-comment-button');

        cancelButton.replaceWith(deleteButton);
      });

      // ì—…ë°ì´íŠ¸ ì‹œ ì„œë²„ë¡œ PATCH ìš”ì²­
      button.addEventListener('click', () => {
        const updatedContent = textarea.value.trim();
        if (!updatedContent) {
          alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        fetch(`/comments/${commentId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          },
          body: JSON.stringify({ comment: { content: updatedContent } }),
          redirect: 'manual',
        })
        .then(res => {
          if (!res.ok) throw new Error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
          if (res.redirected) {
            window.location.href = res.url;
            return;
          }
          return res.json();
        })
        .then(data => {
          const newContentEl = document.createElement('p');
          newContentEl.className = 'comment-content text-sm mt-2 text-gray-700 px-4';
          newContentEl.textContent = data.content;

          textarea.replaceWith(newContentEl);
          button.textContent = 'í¸ì§‘';
          button.classList.remove('update-comment-button');
          button.classList.add('edit-comment-button');

          cancelButton.replaceWith(deleteButton);
        })
        .catch(err => {
          alert('ëŒ“ê¸€ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          console.error(err);
        });
      }, { once: true }); // ì¤‘ë³µ ì´ë²¤íŠ¸ ë°©ì§€
    });
  });
}

  // ì´ˆê¸°ì— ë¡œë“œëœ ëŒ“ê¸€ìš© í¸ì§‘ ë²„íŠ¼ë„ ë°”ì¸ë”©
  bindEditCommentButtons();

  // ëŒ€ëŒ“ê¸€ ë³´ê¸° í† ê¸€
  document.querySelectorAll('.reply-toggle').forEach(button => {
    button.addEventListener('click', () => {
      const commentId = button.getAttribute('data-comment-id');
      const replyContainer = document.getElementById(`reply-container-${commentId}`);

      if (!replyContainer) {
        console.log(`reply-container-${commentId} not found`);
        return;
      }

      const isHidden = replyContainer.classList.contains('hidden');

      if (isHidden) {
        replyContainer.classList.remove('hidden');
        const replyCount = replyContainer.querySelectorAll('.border-l-2').length;
        button.textContent = replyCount === 0 ? 'ë‹µê¸€ ë‹¬ê¸°' : 'ëŒ€ëŒ“ê¸€ ë‹«ê¸°';
      } else {
        replyContainer.classList.add('hidden');
        const replyCount = replyContainer.querySelectorAll('.border-l-2').length;
        button.textContent = replyCount === 0 ? 'ë‹µê¸€ ë‹¬ê¸°' : `ğŸ’¬ ${replyCount}ê°œì˜ ë‹µê¸€ ë³´ê¸°`;
      }
    });
  });

  // textarea ìë™ ë†’ì´ ì¡°ì ˆ
  document.addEventListener('input', function(event) {
    if (event.target.classList.contains('auto-resize-textarea')) {
      const textarea = event.target;
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }
  });

  document.querySelectorAll('.auto-resize-textarea').forEach(textarea => {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
  });

  // ì‹ ê³  ë²„íŠ¼
  const reportButton = document.getElementById('report-button');
  if (reportButton) {
    reportButton.addEventListener('click', () => {
      openReportModal();
    });
  }

  function openReportModal() {
    alert('ì‹ ê³  ëª¨ë‹¬ì„ ì—´ ì˜ˆì •ì…ë‹ˆë‹¤.');
  }
});

document.addEventListener('DOMContentLoaded', () => {
  const copyBtn = document.getElementById('copy-link-btn');
  
  if (copyBtn) {
    copyBtn.addEventListener('click', () => {
      const url = copyBtn.dataset.url;

      navigator.clipboard.writeText(url)
        .then(() => {
          alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        })
        .catch(err => {
          console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        });
    });
  }
});

</script>

</body>
