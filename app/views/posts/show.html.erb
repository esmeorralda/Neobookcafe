<head>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-kopub@1.0/kopubbatang.min.css">
  <style>
   #post-container.grid-active {
  display: flex;
  gap: 2rem;
  max-width: 100vw; /* 최대 화면 너비 */
  padding: 0 2rem;
  box-sizing: border-box;
  justify-content: space-between;
}

#left-column {
  flex-grow: 1;        /* 최대한 크게 */
  min-width: 600px;    /* 최소 너비 확보 */
  max-width: calc(100vw - 400px); /* 오른쪽 최소 400px 확보 후 나머지 */
}
   #comment-sidebar {
  flex-shrink: 0;      /* 크기 줄이지 않음 */
  width: 400px;        /* 댓글 사이드바 고정 너비 */
  overflow-y: auto;
  max-height: 90vh;
  background-color: #f9f6f2;
  border-left: 1px solid #d1d5db;
  padding: 1rem;
  border-radius: 0 8px 8px 0;
  position: sticky;
  top: 4rem;
}
    .hidden {
      display: none !important;
    }
  </style>
</head>

<div class="mx-auto min-h-screen py-10 px-4 font-serif">
  <!-- 본문 + 댓글 사이드바 컨테이너 -->
  <div id="post-container" class="max-w-4xl mx-auto">

    <!-- 왼쪽 컬럼 : 제목, 메타정보, 본문, 전체댓글폼 -->
    <div id="left-column" class="space-y-6 text-gray-800">
      <!-- 제목 / 메타 정보 -->
      <div>
        <h1 class="text-3xl font-semibold text-[#2c1a0d] mb-2"><%= @post.title %></h1>
        <p class="text-sm text-gray-700 mb-2">
          책 제목 <%= @post.book_title %> (<%= @post.book_author %>)
        </p>
        <p class="text-sm text-gray-500 mb-4">
          <%= @post.user.name %> 씀, <%= @post.created_at.strftime('%Y년 %-m월 %-d일') %>
        </p>

        <div class="flex items-center space-x-6 mb-6">
          <div class="flex items-center space-x-1">
            <%= image_tag "icon/post/viewCount.svg", class: "w-4 h-4", alt: "조회수" %>
            <span class="text-xs"><%= @post.view_count.to_i %>회</span>
          </div>
          <div class="flex items-center space-x-1">
            <%= image_tag "icon/post/comments.svg", class: "w-4 h-4", alt: "댓글" %>
            <span class="text-xs"><%= @post.comments.count %>개</span>
          </div>
          <div class="flex items-center space-x-1">
            <%= image_tag "icon/post/likes.svg", class: "w-4 h-4", alt: "좋아요" %>
            <span class="text-xs"><%= @post.like_count.to_i %>개</span>
          </div>
        </div>

        <% if user_signed_in? %>
          <div class="flex space-x-3 mb-6">
            <% like = @post.likes.find_by(user: current_user) %>
            <% if like %>
              <%= button_to like_path(like), method: :delete, params: { likeable_type: 'Post', likeable_id: @post.id }, class: "flex items-center" do %>
                <%= image_tag "icon/post/filledheart.svg", class: "w-5 h-5 text-red-500" %>
                <span class="ml-1 text-xs text-gray-600"><%= @post.likes.count %></span>
              <% end %>
            <% else %>
              <%= button_to likes_path(likeable_type: 'Post', likeable_id: @post.id), method: :post, class: "flex items-center" do %>
                <%= image_tag "icon/post/emptyheart.svg", class: "w-5 h-5 text-gray-400" %>
                <span class="ml-1 text-xs text-gray-600"><%= @post.likes.count %></span>
              <% end %>
            <% end %>

            <% if current_user.bookmarked_posts.exists?(@post.id) %>
              <%= button_to post_unbookmark_path(@post), method: :delete, class: "flex items-center" do %>
                <%= image_tag "icon/post/Vector 41.svg", class: "w-4 h-6 fill-current text-[#97705E]" %>
              <% end %>
            <% else %>
              <%= button_to post_bookmark_path(@post), method: :post, class: "flex items-center" do %>
                <%= image_tag "icon/post/Vector 40.svg", class: "w-4 h-6 fill-current text-gray-400" %>
              <% end %>
            <% end %>

            <%= button_tag type: 'button', class: "flex items-center", id: "report-button" do %>
              <%= image_tag "icon/post/report.svg", class: "w-6 h-6" %>
            <% end %>
          </div>
        <% end %>

        <hr class="border-t border-[#e3d5c6] mb-8" />
      </div>

      <!-- 본문 영역 -->
      <div id="post-content" class="space-y-6 text-base leading-relaxed">
        <% @post.post_blocks.order(:position).each do |block| %>
          <div class="relative flex items-start" id="post-block-wrapper-<%= block.id %>">
            <div class="flex-1">
              <% case block.block_type %>
              <% when 'paragraph' %>
                <p id="post-block-<%= block.id %>" data-block-id="<%= block.id %>"><%= raw(block.content.gsub(/\r?\n/, '<br>')) %></p>
              <% when 'subtitle' %>
                <h2 id="post-block-<%= block.id %>" data-block-id="<%= block.id %>" class="text-lg font-semibold text-[#2c1a0d]"><%= block.content %></h2>
              <% when 'quote' %>
                <blockquote id="post-block-<%= block.id %>" data-block-id="<%= block.id %>" class="pl-4 border-l-4 border-[#2c1a0d] italic text-[#2c1a0d]">“<%= block.content %>”</blockquote>
              <% else %>
                <p id="post-block-<%= block.id %>" data-block-id="<%= block.id %>"><%= simple_format(block.content) %></p>
              <% end %>
            </div>

            <div class="ml-3 flex-shrink-0">
              <button type="button"
                class="text-xs px-2 py-1 border border-gray-300 rounded text-gray-600 hover:bg-gray-100 comment-view-btn"
                data-block-id="<%= block.id %>">
                댓글 보기
              </button>
            </div>
          </div>
        <% end %>
      </div>

      <!-- 전체 댓글 작성 폼 -->
      <div class="mt-10">
        <%= form_with model: Comment.new, url: post_comments_path(@post), local: true do |f| %>
          <%= f.hidden_field :post_id, value: @post.id %>
          <%= f.text_area :content, placeholder: "댓글을 작성해주세요", rows: 3, class: "w-full p-2 border rounded" %>
          <%= f.submit "댓글 등록", class: "mt-2 px-4 py-2 bg-[#8b5e3c] text-white rounded" %>
        <% end %>
      </div>
    </div>

    <!-- 오른쪽 컬럼 : 댓글 사이드바 -->
    <div id="comment-sidebar" class="hidden">
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-semibold text-lg">댓글</h3>
        <button id="close-comment-sidebar" class="text-gray-500 hover:text-gray-800 text-xl">&times;</button>
      </div>
      <div id="comment-sidebar-content" class="space-y-3 text-sm text-gray-700 max-h-[65vh] overflow-y-auto">
        <!-- JS로 댓글 및 폼을 로드 -->
      </div>
    </div>

  </div>

  <!-- 숨겨진 댓글 폼들 (초기에는 숨김) -->
  <div id="hidden-comment-forms" class="hidden">
    <% @post.post_blocks.order(:position).each do |block| %>
      <div id="comment-form-<%= block.id %>" class="hidden mt-2 mb-10 border rounded p-4 bg-[#f9f6f2]">
        <% comments = Comment.where(post_block_id: block.id).order(created_at: :desc) %>
        <% if comments.any? %>
          <div class="space-y-3 max-h-40 overflow-y-auto border-b border-gray-300 pb-3">
            <% comments.each do |comment| %>
              <div>
                <p class="font-semibold text-gray-800 text-sm"><%= comment.user.name %></p>
                <p class="text-gray-700 text-sm mt-1"><%= comment.content %></p>
                <p class="text-xs text-gray-500 mt-1"><%= comment.created_at.strftime('%Y년 %-m월 %-d일 %H:%M') %></p>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-500 text-sm italic mt-2">댓글이 없습니다.</p>
        <% end %>

        <%= form_with model: Comment.new, url: post_comments_path(@post), local: true do |f| %>
          <%= f.hidden_field :post_block_id, value: block.id %>
          <%= f.text_area :content, placeholder: "댓글을 작성해주세요", rows: 2, class: "w-full p-2 border rounded mb-2" %>
          <%= f.submit "댓글 등록", class: "px-4 py-1 bg-[#c9a77e] text-white rounded" %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- 신고 모달 -->
<div id="report-modal"
     class="fixed inset-0 flex justify-center items-center bg-black bg-opacity-50 z-50 hidden">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md border border-gray-300 relative">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold text-center w-full">신고하기</h2>
      <button id="report-close" class="text-gray-500 hover:text-gray-800 text-2xl absolute top-4 right-6">&times;</button>
    </div>

    <textarea id="report-content" class="w-full border border-gray-300 rounded p-2 mb-4"
          rows="4" placeholder="신고 내용을 입력하세요"></textarea>

    <div class="flex justify-end space-x-2">
      <button id="report-cancel" class="px-3 py-1 border rounded text-gray-600">취소</button>
      <button id="report-submit" type="button" class="px-3 py-1 bg-red-500 text-white rounded" data-post-id="<%= @post.id %>">제출</button>
    </div>
  </div>
</div>

<!-- 하이라이트 댓글 버튼 -->
<div id="highlight-comment-btn"
     class="hidden absolute px-2 py-1 text-xs bg-[#c9a77e] text-white rounded shadow cursor-pointer"
     style="z-index: 99999;">
  하이라이트 댓글 달기
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const postContainer = document.getElementById('post-container');
    const commentSidebar = document.getElementById('comment-sidebar');
    const commentSidebarContent = document.getElementById('comment-sidebar-content');
    const closeBtn = document.getElementById('close-comment-sidebar');

    document.querySelectorAll('.comment-view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const blockId = btn.getAttribute('data-block-id');

        commentSidebar.classList.remove('hidden');
        postContainer.classList.add('grid-active');

        loadComments(blockId);
      });
    });

    closeBtn.addEventListener('click', () => {
      commentSidebar.classList.add('hidden');
      postContainer.classList.remove('grid-active');
      commentSidebarContent.innerHTML = '';
    });

    function loadComments(blockId) {
      const commentForm = document.getElementById(`comment-form-${blockId}`);
      if (!commentForm) {
        commentSidebarContent.innerHTML = '<p>댓글이 없습니다.</p>';
        return;
      }
      commentSidebarContent.innerHTML = '';
      const clone = commentForm.cloneNode(true);
      clone.classList.remove('hidden');
      commentSidebarContent.appendChild(clone);

      const form = clone.querySelector('form');
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        fetch(form.action, {
          method: form.method.toUpperCase(),
          headers: { 'Accept': 'application/json' },
          body: formData
        })
        .then(response => {
          if (!response.ok) throw new Error('댓글 등록 실패');
          return response.json();
        })
        .then(data => {
          loadComments(blockId);
          form.querySelector('textarea').value = '';
        })
        .catch(() => alert('댓글 등록에 실패했습니다.'));
      });
    }

    // 신고 모달
    const reportButton = document.getElementById('report-button');
    const reportModal = document.getElementById('report-modal');
    const reportClose = document.getElementById('report-close');
    const reportCancel = document.getElementById('report-cancel');
    const reportSubmit = document.getElementById('report-submit');

    if (reportButton) {
      reportButton.addEventListener('click', () => {
        reportModal.classList.remove('hidden');
      });
    }
    reportClose.addEventListener('click', () => {
      reportModal.classList.add('hidden');
    });
    reportCancel.addEventListener('click', () => {
      reportModal.classList.add('hidden');
    });

    reportSubmit.addEventListener('click', () => {
      const content = document.getElementById('report-content').value.trim();
      if (!content) {
        alert('신고 내용을 입력해주세요.');
        return;
      }
      const postId = reportSubmit.getAttribute('data-post-id');

      alert('신고가 접수되었습니다. 감사합니다.');
      document.getElementById('report-content').value = '';
      reportModal.classList.add('hidden');
    });

    
  });

  
</script>
