<head>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-kopub@1.0/kopubbatang.min.css">
  <meta name="csrf-token" content="<%= form_authenticity_token %>" />
  <style>
    /* ì»¨í…Œì´ë„ˆê°€ flexê°€ ë  ë•Œ ë³¸ë¬¸ê³¼ ëŒ“ê¸€ ì‚¬ì´ë“œë°”ê°€ ë‚˜ë€íˆ */
    #post-container.grid-active {
      display: flex;
      gap: 2rem;
      max-width: 100vw;
      padding: 0 2rem;
      box-sizing: border-box;
      justify-content: space-between;
      align-items: flex-start;
    }

    /* ë³¸ë¬¸ ë„ˆë¹„ ì¡°ì • */
    #left-column {
      flex-grow: 1;
      min-width: 500px;
      max-width: calc(100vw - 440px);
    }

    /* ëŒ“ê¸€ ì‚¬ì´ë“œë°” ê³ ì • ë„ˆë¹„ì™€ ìŠ¤íƒ€ì¼ */
    #comment-sidebar {
      flex-shrink: 0;
      width: 400px;
      max-height: 90vh;
      overflow-y: auto;
      background-color: #f9f6f2;
      border-left: 1px solid #d1d5db;
      padding: 1rem;
      border-radius: 0 8px 8px 0;
      position: sticky;
      top: 4rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    .hidden {
      display: none !important;
    }

    /* ì „ì²´ ëŒ“ê¸€ ì…ë ¥ í¼ ì»¨í…Œì´ë„ˆ */
    #root-comment-form {
      margin-top: 3rem;
      margin-bottom: 4rem;
    }

    /* ì „ì²´ ëŒ“ê¸€ í¼ textarea */
    #root-comment-form textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1c4b2;
      border-radius: 6px;
      resize: vertical;
      font-size: 0.9rem;
      font-family: inherit;
      box-sizing: border-box;
    }

    /* ì „ì²´ ëŒ“ê¸€ í¼ ë²„íŠ¼ */
    #root-comment-form button[type="submit"] {
      margin-top: 0.5rem;
      background-color: #b88b65;
      color: white;
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    #root-comment-form button[type="submit"]:hover {
      background-color: #a5774e;
    }

    /* ëŒ“ê¸€ ë³´ê¸° ë²„íŠ¼ */
    .comment-view-btn {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .comment-view-btn:hover {
      background-color: #f0eadf;
    }

    /* ëŒ“ê¸€ ì‚¬ì´ë“œë°” ë‚´ë¶€ ì œëª© & ë‹«ê¸° ë²„íŠ¼ */
    #comment-sidebar > div:first-child {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    #close-comment-sidebar {
      font-size: 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
      transition: color 0.2s ease;
    }
    #close-comment-sidebar:hover {
      color: #333;
    }

    /* ëŒ“ê¸€ ëª©ë¡ ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì˜ì—­ */
    #comment-sidebar-content {
      overflow-y: auto;
      flex-grow: 1;
      min-height: 200px;
    }

    /* ëŒ“ê¸€ í¼ textarea ì‚¬ì´ë“œë°” ì•ˆ */
    #comment-sidebar-content textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1c4b2;
      border-radius: 6px;
      resize: vertical;
      font-size: 0.9rem;
      font-family: inherit;
      box-sizing: border-box;
      margin-bottom: 0.5rem;
    }

    /* ëŒ“ê¸€ í¼ ë²„íŠ¼ ì‚¬ì´ë“œë°” ì•ˆ */
    #comment-sidebar-content button[type="submit"] {
      background-color: #b88b65;
      color: white;
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    #comment-sidebar-content button[type="submit"]:hover {
      background-color: #a5774e;
    }

    
  </style>
</head>

<body>
<div class="mx-auto min-h-screen py-10 px-4 font-serif">
  <!-- ë³¸ë¬¸ + ëŒ“ê¸€ ì‚¬ì´ë“œë°” ì»¨í…Œì´ë„ˆ -->
  <div id="post-container" class="max-w-4xl mx-auto">

    <!-- ì™¼ìª½ ì»¬ëŸ¼ : ì œëª©, ë©”íƒ€ì •ë³´, ë³¸ë¬¸ -->
    <div id="left-column" class="space-y-6 text-gray-800">
      <!-- ì œëª© / ë©”íƒ€ ì •ë³´ -->
      <div>
        <h1 class="text-3xl font-semibold text-[#2c1a0d] mb-2"><%= @post.title %></h1>
        <p class="text-sm text-gray-700 mb-2">
          ì±… ì œëª© <%= @post.book_title %> (<%= @post.book_author %>)
        </p>
        <p class="text-sm text-gray-500 mb-4">
          <%= @post.user.name %> ì”€, <%= @post.created_at.strftime('%Yë…„ %-mì›” %-dì¼') %>
        </p>

        <div class="flex items-center space-x-6 mb-6">
          <div class="flex items-center space-x-1">
            <%= image_tag "icon/post/viewCount.svg", class: "w-4 h-4", alt: "ì¡°íšŒìˆ˜" %>
            <span class="text-xs"><%= @post.view_count.to_i %>íšŒ</span>
          </div>
          <div class="flex items-center space-x-1">
            <%= image_tag "icon/post/comments.svg", class: "w-4 h-4", alt: "ëŒ“ê¸€" %>
            <span class="text-xs"><%= total_comments_count(@post) %>ê°œ</span>
          </div>
          <div class="flex items-center space-x-1">
            <%= image_tag "icon/post/likes.svg", class: "w-4 h-4", alt: "ì¢‹ì•„ìš”" %>
            <span class="text-xs"><%= @post.like_count.to_i %>ê°œ</span>
          </div>
        </div>

        <% if user_signed_in? %>
          <div class="flex space-x-3 mb-6">
            <% like = @post.likes.find_by(user: current_user) %>
            <% if like %>
              <%= button_to like_path(like), method: :delete, params: { likeable_type: 'Post', likeable_id: @post.id }, class: "flex items-center" do %>
                <%= image_tag "icon/post/filledheart.svg", class: "w-5 h-5 text-red-500" %>
                <span class="ml-1 text-xs text-gray-600"><%= @post.likes.count %></span>
              <% end %>
            <% else %>
              <%= button_to likes_path(likeable_type: 'Post', likeable_id: @post.id), method: :post, class: "flex items-center" do %>
                <%= image_tag "icon/post/emptyheart.svg", class: "w-5 h-5 text-gray-400" %>
                <span class="ml-1 text-xs text-gray-600"><%= @post.likes.count %></span>
              <% end %>
            <% end %>

            <% if current_user.bookmarked_posts.exists?(@post.id) %>
              <%= button_to post_unbookmark_path(@post), method: :delete, class: "flex items-center" do %>
                <%= image_tag "icon/post/Vector 41.svg", class: "w-4 h-6 fill-current text-[#97705E]" %>
              <% end %>
            <% else %>
              <%= button_to post_bookmark_path(@post), method: :post, class: "flex items-center" do %>
                <%= image_tag "icon/post/Vector 40.svg", class: "w-4 h-6 fill-current text-gray-400" %>
              <% end %>
            <% end %>

            <%= button_tag type: 'button', class: "flex items-center", id: "report-button" do %>
              <%= image_tag "icon/post/report.svg", class: "w-6 h-6" %>
            <% end %>
          </div>
        <% end %>

        <hr class="border-t border-[#e3d5c6]" />
      </div>

      <!-- ë³¸ë¬¸ ì˜ì—­ -->
      <div id="post-content" class="space-y-6 text-base leading-relaxed">
        <% @post.post_blocks.order(:position).each do |block| %>
          <div class="relative flex items-start" id="post-block-wrapper-<%= block.id %>">
            <div class="flex-1">
              <% case block.block_type %>
              <% when 'paragraph' %>
                <p id="post-block-<%= block.id %>" data-block-id="<%= block.id %>"><%= raw(block.content.gsub(/\r?\n/, '<br>')) %></p>
              <% when 'subtitle' %>
                <h2 id="post-block-<%= block.id %>" data-block-id="<%= block.id %>" class="text-lg font-semibold text-[#2c1a0d]"><%= block.content %></h2>
              <% when 'quote' %>
                <blockquote id="post-block-<%= block.id %>" data-block-id="<%= block.id %>" class="pl-4 border-l-4 border-[#2c1a0d] italic text-[#2c1a0d]">â€œ<%= block.content %>â€</blockquote>
              <% else %>
                <p id="post-block-<%= block.id %>" data-block-id="<%= block.id %>"><%= simple_format(block.content) %></p>
              <% end %>
            </div>

            <% if block.block_type == 'paragraph' %>
            <div class="ml-3 flex-shrink-0">
              <button type="button"
                class="text-xs px-2 py-1 border border-gray-300 rounded text-gray-600 hover:bg-gray-100 comment-view-btn"
                data-block-id="<%= block.id %>">
                ëŒ“ê¸€ ë³´ê¸°
              </button>
            </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- âœ… ì „ì²´ ëŒ“ê¸€ ì‘ì„± í¼ (ë£¨íŠ¸ ëŒ“ê¸€) ë³¸ë¬¸ ë°”ë¡œ ì•„ë˜ -->
      <% if user_signed_in? %>
        <div id="root-comment-form">
          <%= form_with model: Comment.new, url: post_comments_path(@post), local: true do |f| %>
            <%= f.hidden_field :post_block_id, value: nil %>
              <%= f.hidden_field :post_id, value: @post.id %>
            <%= f.text_area :content, placeholder: "ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”", rows: 2 %>
            <button type="submit">ëŒ“ê¸€ ë“±ë¡</button>
          <% end %>
        </div>
      <% end %>

      <div id="root-comment-list" class="mt-6">
  <% @comments.where(parent_id: nil, post_id: @post.id, post_block_id: nil).order(created_at: :desc).each do |comment| %>
    <div class="border p-3 rounded mb-3 bg-white shadow-sm">
      <div class="flex justify-between items-center">
        <p class="font-semibold text-gray-800 text-sm"><%= comment.user.name %></p>
        <p class="text-xs text-gray-500"><%= comment.created_at.strftime('%Yë…„ %-mì›” %-dì¼ %H:%M') %></p>
      </div>
      <p class="text-gray-700 text-sm mt-1"><%= comment.content %></p>

 <!-- ëŒ€ëŒ“ê¸€ ë³´ê¸°/ë‹µê¸€ ë‹¬ê¸° í† ê¸€ -->
<button class="mt-1 text-xs text-[#b88b65] reply-toggle" data-comment-id="<%= comment.id %>">
  <% if comment.children.any? %>
    ğŸ’¬ <%= comment.children.count %>ê°œì˜ ë‹µê¸€ ë³´ê¸°
  <% else %>
    ë‹µê¸€ ë‹¬ê¸°
  <% end %>
</button>

<!-- ëŒ€ëŒ“ê¸€ ëª©ë¡ + ì…ë ¥ í¼ -->
<div class="ml-4 mt-2 space-y-2 hidden reply-container" id="reply-container-<%= comment.id %>">
  <% comment.children.order(created_at: :asc).each do |reply| %>
    <div class="border-l-2 pl-3 border-[#d1c4b2] bg-[#f9f6f2] rounded-sm py-2">
      <p class="text-xs font-semibold text-gray-700"><%= reply.user.name %></p>
      <p class="text-xs text-gray-700 mt-1"><%= reply.content %></p>
      <p class="text-[11px] text-gray-400 mt-1"><%= reply.created_at.strftime('%Yë…„ %-mì›” %-dì¼ %H:%M') %></p>
    </div>
  <% end %>

  <!-- ëŒ€ëŒ“ê¸€ ì…ë ¥ í¼ -->
<%= form_with model: Comment.new, url: post_comments_path(@post), local: true do |f| %>
    <%= f.hidden_field :post_block_id, value: nil %>
    <%= f.hidden_field :parent_id, value: comment.id %>
    <%= f.hidden_field :post_id, value: @post.id %>
    <%= f.text_area :content, placeholder: "ë‹µê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”", rows: 1, class: "w-full p-1 border rounded text-sm mb-1" %>
   <button type="submit" style="display: inline-block !important; background-color: #b88b65; color: white; padding: 6px 12px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer;">
  ë‹µê¸€ ë“±ë¡
</button>


  <% end %>
</div>

    </div>
  <% end %>
</div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ì»¬ëŸ¼ : ëŒ“ê¸€ ì‚¬ì´ë“œë°” -->
    <div id="comment-sidebar" class="hidden">
      <div>
        <h3 class="font-semibold text-lg">ëŒ“ê¸€</h3>
        <button id="close-comment-sidebar" aria-label="ëŒ“ê¸€ ì‚¬ì´ë“œë°” ë‹«ê¸°">&times;</button>
      </div>
      <div id="comment-sidebar-content" class="text-sm text-gray-700">
        <!-- JSë¡œ ëŒ“ê¸€ ë° í¼ì„ ë¡œë“œ -->
      </div>
    </div>
  </div>

  <!-- ìˆ¨ê²¨ì§„ ëŒ“ê¸€ í¼ë“¤ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
  <div id="hidden-comment-forms" class="hidden">
    <% @post.post_blocks.order(:position).each do |block| %>
      <div id="comment-form-<%= block.id %>" class="hidden mt-2 mb-10 border rounded p-4 bg-[#f9f6f2]">
        <% comments = Comment.where(post_block_id: block.id).order(created_at: :desc) %>
        <% if comments.any? %>
          <div class="space-y-3 max-h-40 overflow-y-auto border-b border-gray-300 pb-3">
            <% comments.each do |comment| %>
              <div>
                <p class="font-semibold text-gray-800 text-sm"><%= comment.user.name %></p>
                <p class="text-gray-700 text-sm mt-1"><%= comment.content %></p>
                <p class="text-xs text-gray-500 mt-1"><%= comment.created_at.strftime('%Yë…„ %-mì›” %-dì¼ %H:%M') %></p>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-500 text-sm italic mt-2">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <% end %>

        <%= form_with model: Comment.new, url: post_comments_path(@post), local: true do |f| %>
          <%= f.hidden_field :post_block_id, value: block.id %>
          <%= f.hidden_field :post_id, value: @post.id %>
          <%= f.text_area :content, placeholder: "ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”", rows: 2, class: "w-full p-2 border rounded mb-2" %>
          <button type="submit" class="px-4 py-1 bg-[#b88b65] text-white rounded">ëŒ“ê¸€ ë“±ë¡</button>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const postContainer = document.getElementById('post-container');
    const commentSidebar = document.getElementById('comment-sidebar');
    const commentSidebarContent = document.getElementById('comment-sidebar-content');
    const closeBtn = document.getElementById('close-comment-sidebar');

    // ë¸”ë¡ë³„ ëŒ“ê¸€ ë³´ê¸° ë²„íŠ¼ í´ë¦­
    document.querySelectorAll('.comment-view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const blockId = btn.getAttribute('data-block-id');

        // ëŒ“ê¸€ ì‚¬ì´ë“œë°” ì—´ê¸°
        commentSidebar.classList.remove('hidden');
        postContainer.classList.add('grid-active');

        loadComments(blockId);
      });
    });

    // ëŒ“ê¸€ ì‚¬ì´ë“œë°” ë‹«ê¸° ë²„íŠ¼ í´ë¦­
    closeBtn.addEventListener('click', () => {
      commentSidebar.classList.add('hidden');
      postContainer.classList.remove('grid-active');
      commentSidebarContent.innerHTML = '';
    });

    // ëŒ“ê¸€ ë¡œë“œ í•¨ìˆ˜ (ë¸”ë¡ë³„)
    function loadComments(blockId) {
      const commentForm = document.getElementById(`comment-form-${blockId}`);
      if (!commentForm) {
        commentSidebarContent.innerHTML = '<p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }
      commentSidebarContent.innerHTML = '';
      const clone = commentForm.cloneNode(true);
      clone.classList.remove('hidden');
      commentSidebarContent.appendChild(clone);

      // ëŒ“ê¸€ í¼ ì œì¶œ ì´ë²¤íŠ¸ ë°”ì¸ë”© (AJAX)
      const form = clone.querySelector('form');
form.addEventListener('submit', (e) => {
  e.preventDefault();
  const formData = new FormData(form);
  const token = document.querySelector('meta[name="csrf-token"]').content;

  fetch(form.action, {
    method: form.method.toUpperCase(),
    headers: {
      'Accept': 'application/json',
      'X-CSRF-Token': token
    },
    body: formData
  })
  .then(async (response) => {
    if (!response.ok) {
      // ì‹¤íŒ¨ ì‹œ JSON ì½ì–´ì„œ ì—ëŸ¬ ë©”ì‹œì§€ ë³´ì—¬ì£¼ê¸°
      const errorData = await response.json();
      const errors = errorData.errors || ['ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨'];
      throw new Error(errors.join(', '));
    }
    return response.json();
  })
  .then(data => {
    alert('ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    window.location.reload();  // ìƒˆë¡œê³ ì¹¨
  })
  .catch(error => alert(`ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`));
});

    }

    // ì‹ ê³  ë²„íŠ¼ ëˆ„ë¥´ë©´ ëª¨ë‹¬ ì—´ê¸°
    const reportButton = document.getElementById('report-button');
    if (reportButton) {
      reportButton.addEventListener('click', () => {
        openReportModal();
      });
    }

    function openReportModal() {
      // ì—¬ê¸°ì— ì‹ ê³  ëª¨ë‹¬ì„ êµ¬í˜„í•˜ê±°ë‚˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜¸ì¶œ
      alert('ì‹ ê³  ëª¨ë‹¬ì„ ì—´ ì˜ˆì •ì…ë‹ˆë‹¤.');
    }

  });
// ëŒ€ëŒ“ê¸€ ë³´ê¸°/ë‹µê¸€ ë‹¬ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ëŒ€ëŒ“ê¸€ ëª©ë¡ê³¼ ì…ë ¥í¼ í† ê¸€
document.querySelectorAll('.reply-toggle').forEach(button => {
  button.addEventListener('click', () => {
    const commentId = button.getAttribute('data-comment-id');
    const replyContainer = document.getElementById(`reply-container-${commentId}`);

    if (!replyContainer) {
      console.log(`reply-container-${commentId} not found`);
      return;
    }

    const isHidden = replyContainer.classList.contains('hidden');
    console.log(`Toggling reply-container-${commentId}, currently hidden: ${isHidden}`);

    if (isHidden) {
      replyContainer.classList.remove('hidden');
      const replyCount = replyContainer.querySelectorAll('.border-l-2').length;
      if (replyCount === 0) {
        button.textContent = 'ë‹µê¸€ ë‹¬ê¸°';
      } else {
        button.textContent = 'ëŒ€ëŒ“ê¸€ ë‹«ê¸°';
      }
    } else {
      replyContainer.classList.add('hidden');
      const replyCount = replyContainer.querySelectorAll('.border-l-2').length;
      if (replyCount === 0) {
        button.textContent = 'ë‹µê¸€ ë‹¬ê¸°';
      } else {
        button.textContent = `ğŸ’¬ ${replyCount}ê°œì˜ ë‹µê¸€ ë³´ê¸°`;
      }
    }
  });
});


</script>
</body>
