<head>
  <meta name="csrf-token" content="<%= form_authenticity_token %>" />
  <style>
    #post-container.grid-active {
      display: flex;
      gap: 2rem;
      max-width: 100vw;
      padding: 0 2rem;
      box-sizing: border-box;
      justify-content: space-between;
      align-items: flex-start;
    }

    #left-column {
      flex-grow: 1;
      min-width: 500px;
      max-width: calc(100vw - 440px);
    }

    #comment-sidebar {
      flex-shrink: 0;
      width: 500px;
      max-height: 95vh;
      overflow-y: auto;
      background-color: #f9f6f2;
      border-left: 1px solid #d1d5db;
      padding: 1rem;
      border-radius: 0 8px 8px 0;
      position: sticky;
      top: 3rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    .hidden { display: none !important; }

    /* JS 준비 전 인터랙티브 요소 숨김 (선택적) */
    :root[data-js-ready="1"] .interactive { display: revert; }
    .interactive { display: none; }

    /* 전체 댓글 입력 폼 컨테이너 */
    #root-comment-form { margin-top: 3rem; }

    .comment-highlight {
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.75rem;
      background-color: #ffffff;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.06);
      border-color 0.25s ease;
    }

    /* 전체 댓글 폼 textarea */
    #root-comment-form textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1c4b2;
      border-radius: 6px;
      resize: vertical;
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    .reply-form textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1c4b2;
      border-radius: 6px;
      resize: vertical;
      font-size: 0.9rem;
      box-sizing: border-box;
      min-height: 2.5rem;
      margin-bottom: 0.5rem;
      transition: border-color 0.3s ease;
    }

    /* 블록별 댓글 textarea */
    .hidden-comment-forms textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1c4b2;
      border-radius: 6px;
      resize: vertical;
      font-size: 0.9rem;
      box-sizing: border-box;
      min-height: 6rem;
      margin-bottom: 0.5rem;
      transition: border-color 0.3s ease;
      height: auto;
    }

    /* 전체 댓글 폼 버튼 */
    #root-comment-form button[type="submit"] {
      margin-top: 0.5rem;
      color: white;
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    #root-comment-form button[type="submit"]:hover { background-color: #a5774e; }

    /* 댓글 보기 버튼 */
    .comment-view-btn {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .comment-view-btn:hover { background-color: #f0eadf; }

    /* 댓글 사이드바 내부 제목 & 닫기 버튼 */
    #comment-sidebar > div:first-child {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    #close-comment-sidebar {
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
      transition: color 0.2s ease;
    }
    #close-comment-sidebar:hover { color: #333; }

    /* 댓글 목록 내부 스크롤 영역 */
    #comment-sidebar-content {
      overflow-y: auto;
      flex-grow: 1;
      min-height: 200px;
      border: none;
    }

    /* 댓글 폼 textarea 사이드바 안 */
    #comment-sidebar-content textarea {
      width: 100%;
      padding: 0.5rem;
      resize: vertical;
      font-size: 0.9rem;
      box-sizing: border-box;
      margin-bottom: 0.5rem;
    }

    /* 댓글 폼 버튼 사이드바 안 */
    #comment-sidebar-content button[type="submit"] {
      color: white;
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
    }
  </style>
</head>

<body>
<div class="mx-auto min-h-screen py-10 px-4 font-serif">
  <!-- 본문 + 댓글 사이드바 컨테이너 -->
  <div id="post-container" class="max-w-4xl mx-auto relative">
    <div id="left-column" class="space-y-6 text-gray-800">
      <!-- 제목 / 메타 정보 -->
      <div>
        <!-- 제목 + 공유/편집/삭제 버튼 한 줄 정렬 -->
        <div class="flex justify-between items-center mb-4">
          <!-- 왼쪽: 제목 -->
          <h1 class="text-3xl font-semibold text-[#2c1a0d]" style="font-family: 'Noto Serif KR', serif;"><%= @post.title %></h1>
          <!-- 오른쪽: 버튼들 -->
          <div class="flex space-x-2" style="font-family: 'Inter', sans-serif;">
            <% if user_signed_in? && @post.user_id == current_user.id %>
              <button id="copy-link-btn" data-url="<%= post_url(@post) %>" class="border border-gray-300 bg-white px-3 py-1 text-sm hover:bg-gray-100 interactive">
                공유하기
              </button>
              <%= link_to "편집", edit_post_path(@post), class: "bg-[#b88b65] text-white px-3 py-1 text-sm hover:bg-[#a27958] interactive" %>
              <%= button_to post_path(@post), method: :delete, data: { confirm: "정말 삭제하시겠습니까?" }, class: "border border-gray-300 bg-white px-3 py-1 text-sm hover:bg-red-100 interactive" do %>
                삭제
              <% end %>
            <% elsif user_signed_in? && current_user.bookmarked_posts.exists?(@post.id) %>
              <%= button_to post_unbookmark_path(@post), method: :delete, class: "flex items-center interactive" do %>
                <%= image_tag "icon/post/Vector 41.svg", class: "w-4 h-6 fill-current text-[#2c1a0d]" %>
              <% end %>
            <% elsif user_signed_in? %>
              <%= button_to post_bookmark_path(@post), method: :post, class: "flex items-center interactive" do %>
                <%= image_tag "icon/post/Vector 40.svg", class: "w-4 h-6 fill-current text-gray-400" %>
              <% end %>
            <% end %>
          </div>
        </div>

        <p class="text-sm text-gray-700 mb-2" style="font-family: 'Noto Serif KR', serif;">
          책 제목 <%= @post.book_title %> (<%= @post.book_author %>)
        </p>

        <p class="text-sm text-gray-900 mb-2 text-right mb-2">
          <%= @post.category.present? ? Post.category_korean[@post.category.to_sym] : "카테고리 없음 " %>,
          <%= @post.book_genre.present? ? Post.book_genre_korean[@post.book_genre.to_sym]: "장르 없음" %>
          <span></span>
        </p>

        <p class="text-sm text-gray-900 mb-2 text-right">
          <%= @post.user.name %> 씀, <%= @post.created_at.strftime('%Y년 %-m월 %-d일') %>
        </p>

        <% if @post.draft %>
          <p class="text-sm space-x-3 mb-2 font-medium">이 글은 작성 중입니다.</p>
        <% else %>
          <!-- 통계 정보 오른쪽 정렬 -->
          <div class="flex justify-end space-x-3 mb-3 text-right">
            <div class="flex items-center space-x-1">
              <%= image_tag "icon/post/viewCount.svg", class: "w-4 h-4", alt: "조회수" %>
              <span class="text-xs"><%= @post.view_count.to_i %>회</span>
            </div>
            <div class="flex items-center space-x-1">
              <%= image_tag "icon/post/comments.svg", class: "w-4 h-4", alt: "댓글" %>
              <span class="text-xs"><%= total_comments_count(@post) %>개</span>
            </div>
            <div class="flex items-center space-x-1">
              <%= image_tag "icon/post/likes.svg", class: "w-4 h-4", alt: "좋아요" %>
              <span class="text-xs"><%= @post.like_count.to_i %>개</span>
            </div>
          </div>
        <% end %>
        <hr class="border-t border-[#e3d5c6] mt-3" />
      </div>

      <!-- 본문 영역 -->
      <div id="post-content" class="space-y-6 text-base leading-relaxed" style="font-family: 'Noto Serif KR', serif;">
        <% @post.post_blocks.order(:position).each do |block| %>
          <div class="relative flex items-start" id="post-block-wrapper-<%= block.id %>">
            <div class="flex-1">
              <% case block.block_type %>
              <% when 'paragraph' %>
                <p id="post-block-<%= block.id %>" data-block-id="<%= block.id %>" class="post-block mt-0 leading-relaxed">
                  <%= raw(block.content.gsub(/\r?\n/, '<br>')) %>
                </p>
              <% when 'subtitle' %>
                <h2 id="post-block-<%= block.id %>" data-block-id="<%= block.id %>" class="post-block text-lg font-semibold text-[#2c1a0d] mt-4 ">
                  <%= block.content %>
                </h2>
              <% when 'quote' %>
                <blockquote id="post-block-<%= block.id %>" data-block-id="<%= block.id %>" class="post-block pl-4 border-l-4 border-[#2c1a0d] italic text-[#2c1a0d] mt-1">
                  “<%= block.content %>”
                </blockquote>
              <% else %>
                <p id="post-block-<%= block.id %>" data-block-id="<%= block.id %>"><%= simple_format(block.content) %></p>
              <% end %>
            </div>

            <% if block.block_type != 'quote' && @post.draft != true %>
              <div class="ml-3 flex-shrink-0">
                <button type="button"
                  class="text-xs px-2 py-1 border border-gray-300 rounded text-gray-600 hover:bg-gray-100 comment-view-btn interactive"
                  style="font-family: 'Inter', sans-serif;"
                  data-block-id="<%= block.id %>">
                  댓글 보기
                </button>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- 좋아요 버튼: 댓글 입력창 위로 이동 -->
      <% if user_signed_in? && @post.draft == false %>
        <div class="flex items-center justify-between mt-12 mb-4">
          <div>
            <% likeable = @post %>
            <% liked = likeable.likes.exists?(user: current_user) %>
            <%= form_with(
              url: liked ? like_path(likeable.likes.find_by(user: current_user)) : likes_path,
              method: liked ? :delete : :post,
              remote: true,
              html: { id: dom_id(likeable, :like_button), class: "like-form interactive" },
              data: { disable_with: "처리 중..." }
            ) do |f| %>
              <%= hidden_field_tag :likeable_type, likeable.class.name %>
              <%= hidden_field_tag :likeable_id, likeable.id %>
              <button type="submit" class="flex items-center space-x-1 focus:outline-none">
                <% if liked %>
                  <%= image_tag "icon/post/filledheart.svg", class: "w-4 h-4" %>
                <% else %>
                  <%= image_tag "icon/post/emptyheart.svg", class: "w-4 h-4" %>
                <% end %>
                <span class="text-xs"><%= likeable.likes.count %></span>
              </button>
            <% end %>
          </div>
        </div>
      <% end %>

      <hr class="border-t border-[#e3d5c6]" />

      <!-- ✅ 전체 댓글 작성 폼 (루트 댓글) 본문 바로 아래 -->
      <%= form_with model: Comment.new, url: post_comments_path(@post), local: true, html: { id: "root-comment-form" } do |f| %>
        <%= f.hidden_field :post_block_id, value: nil %>
        <%= f.hidden_field :post_id, value: @post.id %>

        <% if @post.draft != true %>
          <div class="flex flex-col space-y-1">
            <%= f.text_area :content, placeholder: "답글을 작성해주세요", rows: 4, class: "auto-resize-textarea w-full p-2 border border-[#d1c4b2] rounded text-sm resize-none focus:outline-none focus:ring-1 focus:ring-[#b88b65]" %>
            <div class="flex justify-end mt-2">
              <button type="submit" class="bg-[#5d3b2e] text-white px-4 py-1 rounded text-sm cursor-pointer" style="font-family: 'Inter', sans-serif;">
                댓글 등록
              </button>
            </div>
          </div>
        <% end %>
      <% end %>

      <% if @post.draft != true && @post.comments.any? %>
        <div id="root-comment-list" class="mt-6 max-h-[600px] overflow-y-auto bg-[#f9f6f2] p-4 rounded-lg shadow-inner">

          <!-- 댓글 정렬 드롭다운 -->
          <div class="mb-4 flex items-center space-x-2" style="font-family: 'Inter', sans-serif;">
            <label for="sort-comments" class="text-sm font-medium text-gray-700" style="font-family: 'Inter', sans-serif;">댓글 정렬:</label>
            <select id="sort-comments" name="sort" class="border rounded px-2 py-1 text-sm" onchange="location = this.value;">
              <option value="<%= url_for(params.permit(:id).merge(sort: 'latest')) %>" <%= 'selected' if params[:sort] == 'latest' || params[:sort].blank? %>>최신순</option>
              <option value="<%= url_for(params.permit(:id).merge(sort: 'oldest')) %>" <%= 'selected' if params[:sort] == 'oldest' %>>오래된 순</option>
              <option value="<%= url_for(params.permit(:id).merge(sort: 'likes')) %>" <%= 'selected' if params[:sort] == 'likes' %>>좋아요 순</option>
            </select>
          </div>

          <%# 정렬 처리: params[:sort] 기준으로 @comments를 뷰에서 정렬 %>
          <%
            sorted_comments = case params[:sort]
            when 'oldest' then @comments.sort_by(&:created_at)
            when 'likes'  then @comments.sort_by { |c| -c.likes.count }
            else               @comments.sort_by(&:created_at).reverse
            end
          %>

          <!-- 댓글 리스트 -->
          <div class="space-y-4">
            <% @comments.where(parent_id: nil).each do |comment| %>
              <div class="comment rounded-md p-4 bg-white shadow-sm" data-comment-id="<%= comment.id %>">
                <!-- 유저 이름 + 날짜 + 좋아요 + 버튼 -->
                <div class="flex justify-between items-start">
                  <div>
                    <%= link_to comment.user.name, user_path(comment.user),
                        class: "text-sm font-semibold text-gray-800",
                        style: "font-family: 'Noto Serif KR'; text-decoration: none;" %>
                    <style>
                      a:hover { text-decoration: underline !important; }
                    </style>
                  </div>
                  <div class="flex items-center space-x-2">
                    <p class="text-xs text-gray-400"><%= comment.created_at.strftime('%Y년 %-m월 %-d일 %H:%M') %></p>
                    <%= render partial: 'comment_like', locals: { likeable: comment } %>
                    <% if user_signed_in? && comment.user_id == current_user.id %>
                      <%= button_tag '편집',
                          type: 'button',
                          class: 'edit-comment-button text-xs hover:underline interactive',
                          data: { comment_id: comment.id },
                          style: "font-family: 'Inter', sans-serif;" %>
                      <%= link_to '삭제', comment_path(comment),
                          method: :delete,
                          data: { confirm: '정말 삭제하시겠습니까?' },
                          class: 'text-xs text-red-500 hover:underline',
                          style: 'font-family: Inter, sans-serif;' %>
                    <% end %>
                  </div>
                </div>

                <!-- 댓글 본문 -->
                <div id="comment-content-<%= comment.id %>" class="comment-content">
                  <%= comment.content %>
                </div>

                <%# textarea 초기 높이 계산 (줄바꿈/탭 포함) %>
                <%
                  line_height = 22
                  max_chars_per_line = 50
                  content_text = (comment.content || "").to_s
                  lines = content_text.split("\n")
                  total_lines = lines.inject(0) do |acc, line|
                    if line.strip.empty?
                      acc + 1
                    else
                      line_length = line.gsub("\t", "    ").length
                      acc + (line_length / max_chars_per_line.to_f).ceil
                    end
                  end
                  estimated_lines = [2, total_lines].max
                  initial_height = estimated_lines * line_height
                %>

                <div id="comment-edit-form-<%= comment.id %>" class="comment-edit-form hidden">
                  <%= form_with model: comment, url: comment_path(comment), method: :patch do |f| %>
                    <%= f.text_area :content,
                        value: content_text,
                        style: "height: #{initial_height}px; min-height: #{2*line_height}px; resize: vertical;",
                        class: "auto-resize-textarea w-full p-2 border border-[#d1c4b2] rounded text-sm focus:outline-none focus:ring-1 focus:ring-[#b88b65] mb-2" %>
                    <div class="w-full flex justify-end space-x-2">
                      <%= f.submit '저장', class: "px-2 py-1 bg-[#5d3b2e] text-white rounded text-xs cursor-pointer" %>
                      <button type="button" class="cancel-edit-btn px-2 py-1 bg-gray-300 rounded text-xs cursor-pointer">취소</button>
                    </div>
                  <% end %>
                </div>

                <!-- 답글 토글 -->
                <button
                class="mt-2 text-xs text-[#b88b65] hover:text-[#a5774e] reply-toggle interactive"
                data-comment-id="<%= comment.id %>"
                aria-controls="reply-container-<%= comment.id %>"
                style="font-family: 'Inter', sans-serif;">
                <% if comment.children.any? %>
                  <%= comment.children.count %>개의 답글 보기
                <% else %>
                  답글 달기
                <% end %>
              </button>
              
                <!-- 대댓글 컨테이너 -->
                <div class="ml-4 mt-3 space-y-2 hidden reply-container"
                id="reply-container-<%= comment.id %>">
             <% comment.children.order(created_at: :asc).each do |reply| %>
               <div class="comment rounded-md p-4 bg-[#f9f6f2] shadow-sm" data-comment-id="<%= reply.id %>">
                 <!-- 유저 이름 + 날짜 + 좋아요 + 버튼 -->
                 <div class="flex justify-between items-start">
                   <div>
                     <p class="text-sm font-semibold text-gray-800" style="font-family: 'Noto Serif KR', serif;"><%= reply.user.name %></p>
                   </div>
                   <div class="flex items-center space-x-2">
                     <p class="text-xs text-gray-400"><%= reply.created_at.strftime('%Y년 %-m월 %-d일 %H:%M') %></p>
                     <%= render partial: 'comment_like', locals: { likeable: reply } %>
                     <% if user_signed_in? && reply.user_id == current_user.id %>
                       <%= button_tag '편집',
                           type: 'button',
                           class: 'edit-comment-button text-xs hover:underline interactive',
                           data: { comment_id: reply.id },
                           style: "font-family: 'Inter', sans-serif;" %>
                       <%= link_to '삭제', comment_path(reply),
                           method: :delete,
                           data: { confirm: '정말 삭제하시겠습니까?' },
                           class: 'text-xs text-red-500 hover:underline',
                           style: 'font-family: Inter, sans-serif;' %>
                     <% end %>
                   </div>
                 </div>
           
                 <!-- 본문 (표시용) -->
                 <div class="comment-content text-sm text-gray-700 mt-1" id="comment-content-<%= reply.id %>">
                   <%= reply.content %>
                 </div>
           
                 <!-- ✅ 대댓글 편집 폼 (숨김) -->
                 <div id="comment-edit-form-<%= reply.id %>" class="comment-edit-form hidden mt-2">
                   <%= form_with model: reply, url: comment_path(reply), method: :patch do |f| %>
                     <%= f.text_area :content,
                         value: reply.content,
                         class: "auto-resize-textarea w-full p-2 border border-[#d1c4b2] rounded text-sm focus:outline-none focus:ring-1 focus:ring-[#b88b65] mb-2",
                         style: "min-height: 44px; resize: vertical;" %>
           
                     <div class="w-full flex justify-end space-x-2">
                       <%= f.submit '저장', class: "px-2 py-1 bg-[#5d3b2e] text-white rounded text-xs cursor-pointer" %>
                       <button type="button" class="cancel-edit-btn px-2 py-1 bg-gray-300 rounded text-xs cursor-pointer">취소</button>
                     </div>
                   <% end %>
                 </div>
                 <!-- /대댓글 편집 폼 -->
               </div>
             <% end %>
           
             <!-- 대댓글 작성 폼 -->
             <% if user_signed_in? %>
               <%= form_with model: Comment.new, url: post_comments_path(@post), local: true, html: { class: "reply-form" } do |f| %>
                 <%= f.hidden_field :parent_id, value: comment.id %>
                 <%= f.hidden_field :post_id, value: @post.id %>
                 <%= f.text_area :content, rows: 1, placeholder: "대댓글을 작성해주세요",
                       class: "auto-resize-textarea w-full p-2 border border-[#d1c4b2] rounded text-sm focus:outline-none focus:ring-1 focus:ring-[#b88b65]" %>
                 <div class="flex justify-end mt-1" style="font-family: 'Inter', sans-serif;">
                   <%= f.submit "답글 등록", class: "px-3 py-1 bg-[#5d3b2e] text-white rounded text-xs cursor-pointer" %>
                 </div>
               <% end %>
             <% end %>
           </div>
           
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- 오른쪽 컬럼 : 댓글 사이드바 -->
    <div id="comment-sidebar" class="hidden">
      <div>
        <h3 class="text-lg" style="font-family: 'Inter', sans-serif;">댓글</h3>
        <button id="close-comment-sidebar" aria-label="댓글 사이드바 닫기">&times;</button>
      </div>
      <div id="comment-sidebar-content" class="text-sm text-gray-700">
        <!-- JS로 댓글 및 폼을 로드 -->
      </div>
    </div>
  </div>

  <!-- 숨겨진 댓글 폼들 (초기에는 숨김) -->
  <div id="hidden-comment-forms" class="hidden">
    <% @post.post_blocks.order(:position).each do |block| %>
      <div id="comment-form-<%= block.id %>" class="hidden mt-2 mb-10 rounded p-4 bg-[#f9f6f2]">
        <% comments = Comment.where(post_block_id: block.id).order(created_at: :asc) %>
        <% if comments.any? %>
          <div class="space-y-3 overflow-y-auto pb-3" style="max-height: 500px;">
            <% comments.each do |comment| %>
              <div class="comment border-b border-[#d1c4b2] pb-2 mb-2">
                <!-- 상단: 유저이름 / 날짜 + 하트 -->
                <div class="flex justify-between items-start">
                  <p class="font-semibold text-gray-800 text-sm" style="font-family: 'Noto Serif KR', serif;"><%= comment.user.name %></p>
                  <div class="flex items-center space-x-2" style="line-height: 1.25; font-size: 0.75rem; font-family: 'Inter', sans-serif;">
                    <p class="text-xs text-gray-500"><%= comment.created_at.strftime('%Y년 %-m월 %-d일 %H:%M') %></p>
                    <%= render partial: 'comment_like', locals: { likeable: comment } %>
                    <div class="flex items-center space-x-2">
                      <%= button_tag '편집',
                          type: 'button',
                          class: 'edit-comment-button text-xs hover:underline interactive',
                          data: { comment_id: comment.id },
                          style: "font-family: 'Inter', sans-serif;" %>
                      <%= link_to '삭제', comment_path(comment), method: :delete, data: { confirm: '정말 삭제하시겠습니까?' }, class: 'text-xs text-red-500 hover:underline' %>
                    </div>
                  </div>
                </div>

                <!-- 본문 -->
                <p id="comment-content-<%= comment.id %>" class="comment-content text-sm mt-2 text-gray-700">
                  <%= comment.content %>
                </p>

                <%
                  line_height = 22
                  max_chars_per_line = 50
                  content_text = (comment.content || "").to_s
                  lines = content_text.split("\n")
                  total_lines = lines.inject(0) do |acc, line|
                    if line.strip.empty?
                      acc + 1
                    else
                      line_len = line.gsub("\t", "    ").length
                      acc + (line_len / max_chars_per_line.to_f).ceil
                    end
                  end
                  estimated_lines = [2, total_lines].max
                  initial_height = estimated_lines * line_height
                %>

                <div id="comment-edit-form-<%= comment.id %>" class="comment-edit-form hidden mt-2">
                  <%= form_with model: comment, url: comment_path(comment), method: :patch do |f| %>
                   <%= f.text_area :content,
    value: content_text,
    style: "height: #{initial_height}px; min-height: #{2*line_height}px; resize: vertical;",
    class: "w-full p-2 border border-[#d1c4b2] rounded text-sm focus:outline-none focus:ring-1 focus:ring-[#b88b65] mb-2 auto-resize-textarea" %>

                    <div class="w-full flex justify-end space-x-2">
                      <%= f.submit '저장', class: "px-2 py-1 bg-[#5d3b2e] text-white rounded text-xs cursor-pointer" %>
                      <button type="button" class="cancel-edit-btn px-2 py-1 bg-gray-300 rounded text-xs cursor-pointer">취소</button>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-500 text-sm italic mt-2">댓글이 없습니다.</p>
        <% end %>

        <!-- ⚠️ 중복 id 방지: 폼 id를 블록별로 고유하게 -->
        <%= form_with model: Comment.new, url: post_comments_path(@post), local: true, html: { id: "hidden-comment-form-for-#{block.id}" } do |f| %>
          <%= f.hidden_field :post_block_id, value: block.id %>
          <%= f.hidden_field :post_id, value: @post.id %>
          <div class="mb-1 comment-content">
            <%= f.text_area :content, placeholder: "댓글을 작성해주세요", rows: 3, style: "min-height: 6rem;", class: "auto-resize-textarea w-full p-2 border border-[#d1c4b2] rounded text-sm focus:outline-none focus:ring-1 focus:ring-[#b88b65]" %>
          </div>
          <div class="flex justify-end mt-0">
            <button type="submit" class="px-4 py-2 bg-[#5d3b2e] text-white rounded text-sm" style="font-family: 'Inter', sans-serif;">
              댓글 등록
            </button>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<script>
(function () {
  // --- Skeleton shown immediately in sidebar while loading ---
  const SKELETON_HTML = `
    <div class="space-y-3 animate-pulse">
      <div class="h-4 bg-gray-200 rounded w-1/3"></div>
      <div class="h-3 bg-gray-200 rounded w-2/3"></div>
      <div class="h-24 bg-gray-100 rounded"></div>
      <div class="h-3 bg-gray-200 rounded w-1/2"></div>
      <div class="h-16 bg-gray-100 rounded"></div>
    </div>
  `;

  function autoResize(el) {
    if (!el) return;
    el.style.overflow = 'hidden';
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  }

  // Bind a single global input handler for all .auto-resize-textarea (even dynamically added)
  function bindGlobalAutoResize() {
    if (document.body.dataset.arBound === '1') return;
    document.body.dataset.arBound = '1';

    document.addEventListener('input', (e) => {
      const ta = e.target.closest('textarea.auto-resize-textarea');
      if (ta) autoResize(ta);
    });

    // Initial fit for currently visible ones
    document.querySelectorAll('textarea.auto-resize-textarea').forEach((ta) => {
      if (ta.offsetParent !== null) autoResize(ta);
    });
  }

  function init() {
    const postContainer = document.getElementById('post-container');
    const commentSidebar = document.getElementById('comment-sidebar');
    const commentSidebarContent = document.getElementById('comment-sidebar-content');
    const closeBtn = document.getElementById('close-comment-sidebar');
    if (!postContainer || !commentSidebar || !commentSidebarContent) return;

    document.documentElement.setAttribute('data-js-ready', '1');
    bindGlobalAutoResize();

    // 1) Block "댓글 보기" → open sidebar immediately with skeleton, then clone hidden template
    document.querySelectorAll('.comment-view-btn').forEach((btn) => {
      if (btn.dataset.bound === '1') return;
      btn.dataset.bound = '1';

      btn.addEventListener('click', () => {
        const blockId = btn.getAttribute('data-block-id');

        commentSidebar.classList.remove('hidden');
        postContainer.classList.add('grid-active');
        commentSidebarContent.innerHTML = SKELETON_HTML;

        const tpl = document.getElementById(`comment-form-${blockId}`);
        if (tpl) {
          const clone = tpl.cloneNode(true);
          clone.classList.remove('hidden');

          requestAnimationFrame(() => {
            commentSidebarContent.innerHTML = '';
            commentSidebarContent.appendChild(clone);

            // Fit any visible textareas
            commentSidebarContent
              .querySelectorAll('textarea.auto-resize-textarea')
              .forEach(autoResize);

            // Optional: keep AJAX submit; if server returns {redirect_url}, follow it to show flash
            const form = commentSidebarContent.querySelector('form');
            if (form && !form.dataset.bound) {
              form.dataset.bound = '1';
              form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const token = document.querySelector('meta[name="csrf-token"]').content;
                const res = await fetch(form.action, {
                  method: form.method.toUpperCase(),
                  headers: { 'Accept': 'application/json', 'X-CSRF-Token': token },
                  body: new FormData(form)
                });
                const data = await res.json().catch(() => ({}));
                if (res.ok && data.redirect_url) {
                  window.location.href = data.redirect_url; // let server flash render
                } else if (res.ok) {
                  window.location.reload();
                } else {
                  if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                  } else {
                    alert((data.errors && data.errors.join(', ')) || '댓글 등록 실패');
                  }
                }
              });
            }
          });
        } else {
          // (Optional) Fallback: fetch partial from server if template isn't present
          // fetch(`<%= post_path(@post) %>?block_id=${encodeURIComponent(blockId)}&only=comments`, { headers: { 'Accept': 'text/html' } })
          //   .then(r => r.text())
          //   .then(html => {
          //     commentSidebarContent.innerHTML = html;
          //     commentSidebarContent.querySelectorAll('textarea.auto-resize-textarea').forEach(autoResize);
          //   })
          //   .catch(() => { commentSidebarContent.innerHTML = '<p class="text-sm text-gray-500">댓글을 불러오지 못했습니다.</p>'; });
        }
      });
    });

    // 2) Close sidebar
    if (closeBtn && closeBtn.dataset.bound !== '1') {
      closeBtn.dataset.bound = '1';
      closeBtn.addEventListener('click', () => {
        commentSidebar.classList.add('hidden');
        postContainer.classList.remove('grid-active');
        commentSidebarContent.innerHTML = '';
      });
    }

    // 3) Delegated interactions: reply-toggle / edit / cancel
    if (!document.body.dataset.delegBound) {
      document.body.dataset.delegBound = '1';

      document.addEventListener('click', (e) => {
        // a) Toggle reply container
        const rt = e.target.closest('button.reply-toggle');
        if (rt) {
          const targetId = rt.getAttribute('aria-controls') || `reply-container-${rt.getAttribute('data-comment-id')}`;
          const container = document.getElementById(targetId) || rt.nextElementSibling;
          if (!container || !container.classList.contains('reply-container')) return;

          const willShow = container.classList.contains('hidden');
          container.classList.toggle('hidden');

          if (willShow) {
            requestAnimationFrame(() => {
              container.querySelectorAll('textarea.auto-resize-textarea').forEach(autoResize);
            });
            rt.textContent = '대댓글 닫기';
          } else {
            const count = container.querySelectorAll('[data-comment-id]').length;
            rt.textContent = count > 0 ? `${count}개의 답글 보기` : '답글 달기';
          }
          return;
        }

        // b) Start edit (comment or reply)
        const editBtn = e.target.closest('.edit-comment-button');
        if (editBtn) {
          const id = editBtn.dataset.commentId;
          const content = document.getElementById(`comment-content-${id}`);
          const form = document.getElementById(`comment-edit-form-${id}`);
          if (content) content.classList.add('hidden');
          if (form) {
            form.classList.remove('hidden');
            requestAnimationFrame(() => {
              autoResize(form.querySelector('textarea.auto-resize-textarea'));
            });
          }
          return;
        }

        // c) Cancel edit
        const cancelBtn = e.target.closest('.cancel-edit-btn');
        if (cancelBtn) {
          const form = cancelBtn.closest('.comment-edit-form');
          if (form) {
            const id = form.id.replace('comment-edit-form-', '');
            form.classList.add('hidden');
            const content = document.getElementById(`comment-content-${id}`);
            if (content) content.classList.remove('hidden');
          }
          return;
        }
      });
    }

    // Final touch: fit any visible textareas on init
    document.querySelectorAll('textarea.auto-resize-textarea').forEach((ta) => {
      if (ta.offsetParent !== null) autoResize(ta);
    });
  }

  // Ensure init on first load + Turbo navigations/cached renders
  document.addEventListener('DOMContentLoaded', init);
  document.addEventListener('turbo:load', init);
  document.addEventListener('turbo:render', init);
})();
</script>

</body>
