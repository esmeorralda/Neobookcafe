<div class="max-w-4xl mx-auto mt-10 p-8">
  <h2 class="text-2xl font-bold mb-2">
    <%= params[:category].present? ? Post.category_korean[params[:category].to_sym] : "전체 글" %>
  </h2>

 <p class="text-sm text-gray-400 mb-4">
  <%= case params[:category]
      when "discussion"
        "책의 핵심 주제와 쟁점에 대해 논리적이고 깊이 있는 토론을 나누는 공간입니다."
      when "thought"
        "책과 관련된 감상문과 개인의 공감, 느낌을 자유롭게 나누는 공간입니다."
      when "creation"
        "시, 에세이, 소설 등 다양한 문학 창작물을 자유롭게 올리고 교류하는 공간입니다."
      when "board"
        "독서와 관련된 모든 주제를 다루는 열린 커뮤니티 공간입니다."
      end %>
</p>

  <div class="mb-1 text-right">
    <form method="get" action="">
      <input type="hidden" name="category" value="<%= params[:category] %>" />
            <input type="hidden" name="book_genre" value="<%= params[:book_genre] %>" /> 
      <select name="sort" onchange="this.form.submit()" class="border border-gray-300 rounded px-2 py-1">
        <option value="newest" <%= params[:sort] == "newest" || params[:sort].blank? ? "selected" : "" %>>최신순</option>
        <option value="most_comments" <%= params[:sort] == "most_comments" ? "selected" : "" %>>댓글순</option>
        <option value="most_views" <%= params[:sort] == "most_views" ? "selected" : "" %>>조회순</option>
        <option value="most_likes" <%= params[:sort] == "most_likes" ? "selected" : "" %>>좋아요순</option>
      </select>
    </form>
  </div>

  <div class="space-y-3">
    <% @posts.each do |post| %>
<div class="p-3 border-b border-[#ddd6ce] flex justify-between items-start">
        <div style="flex:1; min-width: 0;">
          <h3 class="text-lg font-semibold text-[#3a2d20] mb-1" style="font-family: 'Noto Serif KR', serif; font-weight: 700;">
            <%= link_to truncate(post.title, length: 40), post_path(post), class: "hover:underline" %>
            <span class="text-sm text-[#b67c4a] ml-2" style="font-family: 'Inter', sans-serif;">
              책 제목<%= post.id.to_s.rjust(8, "0") %>
            </span>
          </h3>

          <p class="text-xs text-[#7c6243] mb-1" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <%= Post.book_genre_korean[post.book_genre.to_sym] || "정보 없음" %> |
            <%= post.category.present? ? Post.category_korean[post.category.to_sym] : "정보 없음" %>
          </p>

          <p class="text-sm text-[#5e5147] font-serif leading-snug mb-2" style="font-family: 'Noto Serif KR', serif; overflow: hidden; text-overflow: ellipsis;">
            <%= truncate(post.post_blocks.first&.content || "", length: 170) %>
          </p>
        </div>

        <!-- 작성자/날짜 및 통계 오른쪽 아래 정렬 -->
        <div class="flex flex-col justify-end items-end text-xs text-[#999]" style="font-family: 'Inter', sans-serif; min-width: 160px;">
          <span class="mb-1 break-words text-right">
            <%= time_ago_in_korean(post.created_at) %>, <%= post.user&.name || post.user&.email || "익명" %> 씀
          </span>

          <% unless post.draft? %>
            <div class="flex items-center space-x-3">
              <span class="flex items-center space-x-1">
                <%= image_tag("icon/post/brownviews.svg", alt: "views icon", class: "w-4 h-4") %>
                <span><%= post.view_count || 0 %></span>
              </span>

              <span class="flex items-center space-x-1">
                <%= image_tag("icon/post/brownoutlinedhear.svg", alt: "likes icon", class: "w-4 h-4") %>
                <span><%= post.like_count || 0 %></span>
              </span>

              <span class="flex items-center space-x-1">
                <%= image_tag("icon/post/browncomments.svg", alt: "comments icon", class: "w-4 h-4") %>
                <span><%= total_comments_count(post) %></span>
              </span>
            </div>
          <% else %>
            <span class="italic text-[#aa0000]">작성중인 게시물입니다.</span>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
  <% current_page = page_no.to_i %>
  <% total_pages = @total_pages.to_i %>
  <% max_visible = 4 %>

  <%# 페이지 범위 계산 %>
  <% start_page = [current_page - 1, 1].max %>
  <% end_page = [start_page + max_visible - 1, total_pages].min %>

  <%# 보정: 최대 개수 유지 보장 %>
  <% if (end_page - start_page + 1) < max_visible && start_page > 1 %>
    <% start_page = [end_page - max_visible + 1, 1].max %>
  <% end %>

  <div class="pagination flex items-center justify-center space-x-2 mt-4 text-sm">
    <%# 왼쪽 화살표 (<) %>
    <% if start_page > 1 %>
      <%= link_to "&laquo;".html_safe, url_for(params.permit(:category, :sort).merge(page: start_page - 1, per_page: per_page)), class: "px-2 py-1 rounded hover:bg-gray-100" %>
    <% end %>

    <%# 페이지 숫자들 %>
    <% (start_page..end_page).each do |page| %>
      <% if page == current_page %>
        <span class="px-3 py-1 font-bold"><%= page %></span>
      <% else %>
        <%= link_to page, url_for(params.permit(:category, :sort).merge(page: page, per_page: per_page)), class: "px-3 py-1 rounded hover:bg-gray-100 font-light" %>
      <% end %>
    <% end %>

    <%# 오른쪽 화살표 (>) %>
    <% if end_page < total_pages %>
      <%= link_to "&raquo;".html_safe, url_for(params.permit(:category, :sort).merge(page: end_page + 1, per_page: per_page)), class: "px-2 py-1 rounded hover:bg-gray-100" %>
    <% end %>
  </div>
</div>
