<div class="max-w-4xl mx-auto mt-10 p-8 bg-[#f7f1ea] rounded shadow">
  <%= form_with model: @post, local: true, class: "space-y-6", id: "post-form" do |f| %>
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-xl font-bold text-gray-800">새 포스트 작성</h1>
      <div class="space-x-2">
        <button type="button" class="border border-gray-300 bg-white px-3 py-1 text-sm">미리 보기</button>
        <button type="button" class="border border-gray-300 bg-white px-3 py-1 text-sm">임시 저장</button>
        <%= f.submit "업로드", class: "bg-[#5d3b2e] text-white px-4 py-1 rounded text-sm" %>
      </div>
    </div>

    <!-- 기본 정보 -->
    <div class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <%= f.label :category, "게시판 선택", class: "block mb-1" %>
        <%= f.select :category, [["감상문", "thought"], ["논설문", "discussion"], ["창작물", "creation"], ["자유게시글", "board"]], {}, class: "w-full border border-gray-300 p-2 rounded bg-white", id: "category-select" %>
      </div>
      <div>
        <%= f.label :book_title, "책 제목", class: "block mb-1" %>
        <%= f.text_field :book_title, class: "w-full border border-gray-300 p-2 rounded" %>
      </div>
      <div>
        <%= f.label :book_author, "책 저자", class: "block mb-1" %>
        <%= f.text_field :book_author, class: "w-full border border-gray-300 p-2 rounded" %>
      </div>
    </div>

    <div class="text-sm">
      <%= f.label :title, "제목", class: "block mb-1" %>
      <%= f.text_field :title, class: "w-full border border-gray-300 p-2 rounded" %>
    </div>

    <!-- 장르 선택 -->
    <div id="genre-container">
      <span class="text-sm mr-2">장르</span>

      <% ["철학", "문학", "역사", "사회", "경제", "과학/기술"].each do |genre| %>
        <label class="mr-2 text-sm genre-default">
          <%= check_box_tag "genres[]", genre %> <%= genre %>
        </label>
      <% end %>

      <% ["시", "에세이", "소설"].each do |genre| %>
        <label class="mr-2 text-sm genre-creation hidden">
          <%= check_box_tag "genres[]", genre %> <%= genre %>
        </label>
      <% end %>

      <% ["책 추천", "책 홍보", "작가 이야기", "독서팁/습관", "책 관련 행사 홍보", "책 Q&A", "기타"].each do |genre| %>
        <label class="mr-2 text-sm genre-board hidden">
          <%= check_box_tag "genres[]", genre %> <%= genre %>
        </label>
      <% end %>

      <label class="ml-4 text-sm">
        <%= check_box_tag :allow_comments, true %> 댓글 허용
      </label>
    </div>

    <!-- 본문 (종이 느낌 영역) -->
    <div id="blocks-container" class="bg-white p-6 rounded shadow mt-4" style="min-height: 800px; max-height: 1200px; overflow-y: auto; font-family: 'Noto Sans KR', sans-serif;">
      <!-- 자바스크립트로 동적 블록 생성 -->
    </div>

  <% end %>
</div>

<style>
  #blocks-container {
  border: 1px solid #ddd;
  box-shadow: inset 0 0 5px #eee;
  padding: 1rem 1.5rem;
  font-family: 'Noto Sans KR', sans-serif;
  min-height: 800px;
  max-height: 1200px;
  overflow-y: auto;
  line-height: 1.4; /* 워드 같은 기본 줄간격 */
}

.block {
  position: relative;
  padding: 0; /* 블록 내부 여백 없앰 */
  margin-bottom: 0.3rem; /* 블록 간격 아주 좁게 */
  border-bottom: none; /* 구분선 제거하거나 필요시 넣기 */
}

.block textarea {
  width: 100%;
  font-size: 1rem;
  border: none;
  resize: none;
  background: yellow;
  outline: none;
  min-height: 1.4rem; /* 최소 한 줄 높이 */
  line-height: 1.4;
  margin: 0;
  padding: 0;
  font-family: inherit;
  overflow-y: hidden; /* 스크롤바 숨김 */
  height: auto; /* 높이 자동 조절 */
  border-color: black; /* 테두리 제거 */
}


/* 호버 시 컨트롤은 기존 유지 */
.block .block-controls {
  position: absolute;
  top: 0.1rem;
  right: 0.5rem;
  opacity: 0;
  transition: opacity 0.2s ease-in-out;
}

.block:hover .block-controls {
  opacity: 1;
}

.block-controls select {
  font-size: 0.8rem;
  margin-right: 0.3rem;
}

.remove-block-btn {
  background: transparent;
  border: none;
  color: #e00;
  font-weight: bold;
  cursor: pointer;
  padding: 0;
  font-size: 0.9rem;
  line-height: 1;
}

</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("blocks-container");
    let index = 0;

    // textarea 자동 높이 조절 함수
    function autoResizeTextarea(textarea) {
      textarea.style.height = "auto";
      textarea.style.height = textarea.scrollHeight + "px";
    }

    // 블록 생성 함수
    function createBlock(type = "paragraph", content = "") {
      const block = document.createElement("div");
      block.classList.add("block");

      // textarea
      const textarea = document.createElement("textarea");
      textarea.name = `post[post_blocks_attributes][${index}][content]`;
      textarea.value = content;
      textarea.placeholder = "내용을 입력하세요";
      textarea.setAttribute("rows", 1);

      autoResizeTextarea(textarea);
      textarea.addEventListener("input", () => autoResizeTextarea(textarea));

      // 블록 타입 선택 셀렉트
      const select = document.createElement("select");
      select.name = `post[post_blocks_attributes][${index}][block_type]`;
      select.className = "block-type-selector";

      const options = [
        { val: "paragraph", label: "문단" },
        { val: "quote", label: "인용" },
        { val: "subtitle", label: "소제목" }
      ];
      options.forEach(opt => {
        const option = document.createElement("option");
        option.value = opt.val;
        option.textContent = opt.label;
        if (opt.val === type) option.selected = true;
        select.appendChild(option);
      });

      // 삭제 버튼
      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.textContent = "삭제 ✕";
      removeBtn.className = "remove-block-btn";
      removeBtn.title = "블록 삭제";

      const controls = document.createElement("div");
      controls.className = "block-controls";
      controls.appendChild(select);
      controls.appendChild(removeBtn);

      block.appendChild(textarea);
      block.appendChild(controls);
      container.appendChild(block);

      textarea.focus();

      removeBtn.addEventListener("click", () => {
        container.removeChild(block);
      });

      // 엔터(Shift 없이) 누르면 새 블록 생성
      textarea.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          createBlock();
        }
      });

      index++;
    }

    createBlock(); // 최초 1개 블록 생성

    // 카테고리 장르 필터
    const categorySelect = document.getElementById("category-select");

    function toggleGenres() {
      const selected = categorySelect.value;
      document.querySelectorAll(".genre-default").forEach(el => el.classList.toggle("hidden", selected !== "thought" && selected !== "discussion"));
      document.querySelectorAll(".genre-creation").forEach(el => el.classList.toggle("hidden", selected !== "creation"));
      document.querySelectorAll(".genre-board").forEach(el => el.classList.toggle("hidden", selected !== "board"));
    }

    categorySelect.addEventListener("change", toggleGenres);
    toggleGenres();
  });

  function autoResizeTextarea(textarea) {
  textarea.style.height = 'auto'; // 초기화
  textarea.style.height = textarea.scrollHeight + 'px'; // 내용 높이에 맞게 설정
}

document.querySelectorAll('.block textarea').forEach(textarea => {
  autoResizeTextarea(textarea); // 초기 로드 시 조절
  textarea.addEventListener('input', () => autoResizeTextarea(textarea)); // 입력 시마다 조절
});

</script>
