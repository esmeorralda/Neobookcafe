<div class="max-w-4xl mx-auto mt-10 p-8 bg-[#f7f1ea] rounded shadow">
  <%= form_with model: @post, local: true, class: "space-y-6", id: "post-form" do |f| %>
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-xl font-bold text-gray-800">새 포스트 작성</h1>
      <div class="space-x-2">
        <button type="button" class="border border-gray-300 bg-white px-3 py-1 text-sm">미리 보기</button>
        <button type="button" class="border border-gray-300 bg-white px-3 py-1 text-sm">임시 저장</button>
        <%= f.submit "업로드", class: "bg-[#5d3b2e] text-white px-4 py-1 rounded text-sm" %>
      </div>
    </div>

    <!-- 기본 정보 -->
    <div class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <%= f.label :category, "게시판 선택", class: "block mb-1" %>
        <%= f.select :category, [["감상문", "thought"], ["논설문", "discussion"], ["창작물", "creation"], ["자유게시글", "board"]], {}, class: "w-full border border-gray-300 p-2 rounded bg-white", id: "category-select" %>
      </div>
      <div>
        <%= f.label :book_title, "책 제목", class: "block mb-1" %>
        <%= f.text_field :book_title, class: "w-full border border-gray-300 p-2 rounded" %>
      </div>
      <div>
        <%= f.label :book_author, "책 저자", class: "block mb-1" %>
        <%= f.text_field :book_author, class: "w-full border border-gray-300 p-2 rounded" %>
      </div>
    </div>

    <div class="text-sm">
      <%= f.label :title, "제목", class: "block mb-1" %>
      <%= f.text_field :title, class: "w-full border border-gray-300 p-2 rounded" %>
    </div>

    <!-- 장르 선택 -->
    <div id="genre-container">
      <span class="text-sm mr-2">장르</span>

      <% ["철학", "문학", "역사", "사회", "경제", "과학/기술"].each do |genre| %>
        <label class="mr-2 text-sm genre-default">
          <%= check_box_tag "genres[]", genre %> <%= genre %>
        </label>
      <% end %>

      <% ["시", "에세이", "소설"].each do |genre| %>
        <label class="mr-2 text-sm genre-creation hidden">
          <%= check_box_tag "genres[]", genre %> <%= genre %>
        </label>
      <% end %>

      <% ["책 추천", "책 홍보", "작가 이야기", "독서팁/습관", "책 관련 행사 홍보", "책 Q&A", "기타"].each do |genre| %>
        <label class="mr-2 text-sm genre-board hidden">
          <%= check_box_tag "genres[]", genre %> <%= genre %>
        </label>
      <% end %>

      <label class="ml-4 text-sm">
        <%= check_box_tag :allow_comments, true %> 댓글 허용
      </label>
    </div>

    <!-- 기본 문단 블록 -->
    <div>
      <label class="block text-sm font-semibold mb-2">문단 내용</label>
      <%= f.fields_for :post_blocks, f.object.post_blocks.build(block_type: :paragraph, position: 0) do |block_form| %>
        <div class="relative border border-gray-300 p-4 bg-white rounded">
          <div class="absolute top-2 left-2 text-xs text-gray-600">
            블록 유형: <%= block_form.select :block_type, [["문단", "paragraph"], ["인용", "quote"], ["소제목", "subtitle"]], {}, class: "text-sm border border-gray-300 rounded p-1" %>
          </div>
          <%= block_form.text_area :content, rows: 4, class: "mt-6 w-full border border-gray-300 p-2 rounded bg-white resize-none text-sm" %>
        </div>
      <% end %>
    </div>

    <!-- 동적 블록 추가 영역 -->
    <div id="blocks-container" class="space-y-4 mt-4"></div>

    <!-- 블록 추가 버튼 -->
    <div class="flex space-x-2 mt-4">
      <button type="button" class="bg-[#5d3b2e] text-white px-3 py-1 rounded text-sm" data-block-type="paragraph">+ 문단</button>
      <button type="button" class="bg-[#5d3b2e] text-white px-3 py-1 rounded text-sm" data-block-type="quote">+ 인용</button>
      <button type="button" class="bg-[#5d3b2e] text-white px-3 py-1 rounded text-sm" data-block-type="subtitle">+ 소제목</button>
    </div>
  <% end %>
</div>

<!-- 템플릿 -->
<template id="block-template">
  <div class="block-item border border-gray-300 p-4 rounded bg-white relative">
    <div class="absolute top-2 left-2 text-xs text-gray-600">
      블록 유형:
      <select name="post[post_blocks_attributes][__INDEX__][block_type]" class="text-sm border border-gray-300 rounded p-1">
        <option value="paragraph">문단</option>
        <option value="quote">인용</option>
        <option value="subtitle">소제목</option>
      </select>
    </div>
    <textarea name="post[post_blocks_attributes][__INDEX__][content]" rows="4" class="mt-6 w-full border border-gray-300 p-2 rounded resize-none text-sm bg-white" placeholder="내용을 입력해주세요"></textarea>
    <input type="hidden" name="post[post_blocks_attributes][__INDEX__][_destroy]" value="false">
    <button type="button" class="mt-1 text-red-500 text-sm remove-block">삭제 ✕</button>
  </div>
</template>

<script>
   history.replaceState({}, '', "<%= posts_path %>");
  
document.addEventListener("DOMContentLoaded", () => {
  let index = 1;

  const container = document.getElementById("blocks-container");
  const template = document.getElementById("block-template");

  document.querySelectorAll("button[data-block-type]").forEach(button => {
    button.addEventListener("click", () => {
      const blockType = button.getAttribute("data-block-type");
      const blockTemplate = template.content.cloneNode(true);
      const blockDiv = blockTemplate.querySelector("div.block-item");

      blockDiv.dataset.blockType = blockType;
      blockDiv.innerHTML = blockDiv.innerHTML.replace(/__INDEX__/g, index);

      const select = blockDiv.querySelector("select");
      if (select) select.value = blockType;

      container.appendChild(blockDiv);
      index++;
    });
  });

  container.addEventListener("click", (e) => {
    if (e.target.classList.contains("remove-block")) {
      const blockDiv = e.target.closest(".block-item");
      const destroyInput = blockDiv.querySelector('input[name*="_destroy"]');
      if (destroyInput) destroyInput.value = "1";
      blockDiv.style.display = "none";
    }
  });

  const categorySelect = document.getElementById("category-select");

  function toggleGenres() {
    const selected = categorySelect.value;
    document.querySelectorAll(".genre-default").forEach(el => el.classList.toggle("hidden", selected !== "thought" && selected !== "discussion"));
    document.querySelectorAll(".genre-creation").forEach(el => el.classList.toggle("hidden", selected !== "creation"));
    document.querySelectorAll(".genre-board").forEach(el => el.classList.toggle("hidden", selected !== "board"));
  }

  categorySelect.addEventListener("change", toggleGenres);
  toggleGenres();
});
</script>
