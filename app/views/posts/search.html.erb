<div class="max-w-4xl mx-auto mt-10 p-8">
  <h2 class="text-2xl font-bold mb-2">
    “<%= h @query %>” 검색 결과 (<%= @posts.total_count %>건)
  </h2>

  <p class="text-sm text-gray-400 mb-4">검색 결과에 대한 설명을 여기에 넣어보세요</p>

  <div class="mb-6">
  <form method="get" action="">
    <input type="hidden" name="q" value="<%= h @query %>" />

    <label for="category">카테고리:</label>
    <select name="category" id="category" onchange="this.form.submit()" class="border border-gray-300 rounded px-2 py-1 mr-2">
      <option value="">전체</option>
      <% Post.category_korean.each do |key, value| %>
        <option value="<%= key %>" <%= params[:category] == key.to_s ? "selected" : "" %>><%= value %></option>
      <% end %>
    </select>

    <label for="genre">장르:</label>
    <select name="genre" id="genre" onchange="this.form.submit()" class="border border-gray-300 rounded px-2 py-1 mr-2">
      <option value="">전체</option>
      <% Post.book_genre_korean.each do |key, value| %>
        <option value="<%= key %>" <%= params[:genre] == key.to_s ? "selected" : "" %>><%= value %></option>
      <% end %>
    </select>

    <label for="sort">정렬:</label>
    <select name="sort" id="sort" onchange="this.form.submit()" class="border border-gray-300 rounded px-2 py-1">
      <option value="relevance" <%= params[:sort] == "relevance" || params[:sort].blank? ? "selected" : "" %>>관련도순</option>
      <option value="newest" <%= params[:sort] == "newest" ? "selected" : "" %>>최신순</option>
      <option value="most_comments" <%= params[:sort] == "most_comments" ? "selected" : "" %>>댓글순</option>
      <option value="most_views" <%= params[:sort] == "most_views" ? "selected" : "" %>>조회순</option>
      <option value="most_likes" <%= params[:sort] == "most_likes" ? "selected" : "" %>>좋아요순</option>
    </select>
  </form>
</div>


  <% if @posts.any? %>
    <div class="space-y-6">
      <% @posts.each do |post| %>
        <div class="p-6 border-b border-[#ddd6ce]">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="text-lg font-semibold text-[#3a2d20] mb-1">
                <%= link_to truncate(post.title, length: 40), post_path(post), class: "hover:underline" %>
                <span class="text-sm text-[#b67c4a] ml-2">책 제목<%= post.id.to_s.rjust(8, "0") %></span>
              </h3>
              <p class="text-sm text-[#5e5147] leading-snug mb-2">
                <%= truncate(post.post_blocks.first&.content || "", length: 120) %>
              </p>
              <div class="text-xs text-[#999] space-x-2">
                <span><%= time_ago_in_korean(post.created_at) %>, <%= post.user&.name || "익명" %> 씀</span>
                <span>👁️‍🗨️ <%= post.view_count || 0 %></span>
                <span>🤍 <%= post.like_count || 0 %></span>
                <span>💬 댓글수는 나중에</span>
              </div>
            </div>
            <div>
              <%= link_to "#", class: "text-gray-400 hover:text-gray-600" do %>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                </svg>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>

<% current_page = @posts.current_page.to_i %>
<% total_pages = @total_pages.to_i %>
<% max_visible = 4 %>

<%# 페이지 범위 계산 %>
<% start_page = [current_page - 1, 1].max %>
<% end_page = [start_page + max_visible - 1, total_pages].min %>

<%# 보정: 최대 개수 유지 보장 %>
<% if (end_page - start_page + 1) < max_visible && start_page > 1 %>
  <% start_page = [end_page - max_visible + 1, 1].max %>
<% end %>

<div class="pagination flex items-center space-x-2 mt-4 text-sm">

  <%# 왼쪽 화살표 (<<) %>
  <% if start_page > 1 %>
    <%= link_to "&laquo;".html_safe, search_posts_path(q: @query, page: start_page - 1, sort: params[:sort]), class: "px-2 py-1 border rounded hover:bg-gray-100" %>
  <% end %>

  <%# 페이지 숫자들 %>
  <% (start_page..end_page).each do |page| %>
    <% if page == current_page %>
      <span class="px-3 py-1 font-bold"><%= page %></span>
    <% else %>
      <%= link_to page, search_posts_path(q: @query, page: page, sort: params[:sort]), class: "px-3 py-1 border rounded hover:bg-gray-100" %>
    <% end %>
  <% end %>

  <%# 오른쪽 화살표 (>>) %>
  <% if end_page < total_pages %>
    <%= link_to "&raquo;".html_safe, search_posts_path(q: @query, page: end_page + 1, sort: params[:sort]), class: "px-2 py-1 border rounded hover:bg-gray-100" %>
  <% end %>

</div>

  <% else %>
    <p class="text-gray-500 mt-4">검색 결과가 없습니다.</p>
  <% end %>
</div>
