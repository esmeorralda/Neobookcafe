<!-- ì „ì²´ ë°°ê²½ -->
<div class="min-h-screen bg-[#f7f1ea] flex flex-col">
  <!-- ìƒë‹¨ ì—¬ë°± ì œê±° -->
  <main class="flex-1">
<div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow space-y-6 mt-5">

  <h2 class="text-xl font-bold text-gray-800">
    <% if @note&.book.present? %>
      <%= @note.book.title %>
    <% elsif @note&.book_id == "new_book" %>
      <%= params[:note][:book_title].presence || "ìƒˆë¡œìš´ ë©”ëª¨" %>
    <% else %>
      ìƒˆë¡œìš´ ë©”ëª¨
    <% end %>
  </h2>

  <%= form_with(model: @note, local: true) do |f| %>

    <!-- ğŸ“˜ ì±… ì„ íƒ -->
    <div id="book_select_wrapper" class="mb-4">
      <%= label_tag :book_id, "ì±… ì„ íƒ ë˜ëŠ” ìƒˆë¡œ ì…ë ¥", class: "block font-medium mb-1" %>
      <%= select_tag "note[book_id]",
          options_for_select(
            [["ğŸ“– ìƒˆë¡œìš´ ì±… ì…ë ¥", "new_book"]] + current_user.books.pluck(:title, :id),
            selected: @note.book_id
          ),
          prompt: "ì±…ì„ ì„ íƒí•˜ì„¸ìš”",
          class: "w-full border border-gray-300 rounded p-2",
          id: "book_select" %>
    </div>

    <!-- ìƒˆ ì±… ì œëª© ì…ë ¥ í•„ë“œ (ì´ˆê¸°ì—” ìˆ¨ê¹€) -->
    <div id="new_book_title_field" class="mb-4 hidden">
      <%= label_tag "note[book_title]", "ìƒˆ ì±… ì œëª©", class: "block font-medium mb-1" %>
      <%= text_field_tag "note[book_title]", nil, placeholder: "ì˜ˆ: ë‚˜ë¯¸ì•¼ ì¡í™”ì ì˜ ê¸°ì ", class: "w-full border border-gray-300 rounded p-2" %>
    </div>

   

    <!-- ìª½ìˆ˜ì™€ ëª©ì°¨ ì˜ì—­ë§Œ ê·¸ë¦¬ë“œ -->
    <!-- ìƒˆ ì±… ì œëª© ì…ë ¥ í•„ë“œ (ì´ˆê¸°ì—” ìˆ¨ê¹€) -->
   <div class="flex items-center space-x-6"> <!-- items-centerë¡œ ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ -->
   

    <div class="flex flex-col space-y-2">
     <label for="page_from_field " class="block font-medium mb-1 text-sm text-gray-700 leading-6">ë²”ìœ„</label> <!-- í°íŠ¸ í¬ê¸°, ì¤„ë†’ì´ ë™ì¼í•˜ê²Œ -->
      <div class="flex items-center space-x-2 mb-2">
     
        <%= f.number_field :page_from, id: "page_from_field", class: "w-20 border border-gray-300 rounded-md p-2 text-sm" %>
      <span class="text-sm text-gray-700 leading-6">ìª½ë¶€í„° ~ </span>
      <%= f.number_field :page_to, class: "w-20 border border-gray-300 rounded-md p-2 text-sm" %>
      <span class="text-sm text-gray-700 leading-6">ìª½ê¹Œì§€</span>
      </div>
      </div>


      <!-- ëª©ì°¨ ë“œë¡­ë‹¤ìš´ ì˜ì—­ -->
      <div  class="flex flex-col flex-1 space-y-2" id="chapter_select_wrapper">
         <%= label_tag :chapter_id, "ëª©ì°¨ ì„ íƒ ë˜ëŠ” ìƒˆë¡œ ì…ë ¥", class: "block font-medium mb-1 text-sm text-gray-700 leading-6", id: "chapter_select_label" %>  
       <%= select_tag "note[chapter_id]",
        options_for_select(
          (@chapters || []).map { |ch| [ch.title, ch.id] } + [["â• ìƒˆë¡œìš´ ëª©ì°¨ ì…ë ¥", "new_chapter"]],
          selected: @note.chapter_id
        ),
        prompt: "ëª©ì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”",
        class: "w-full border border-gray-300 rounded p-2",
        id: "chapter_select" %>

    <div id="new_chapter_title_field" class="mt-2 hidden">
      <%= label_tag "note[chapter_title]", "ìƒˆ ëª©ì°¨ ì œëª©", class: "block font-medium mb-1 text-sm text-gray-700 leading-6" %>
      <%= text_field_tag "note[chapter_title]", nil, placeholder: "ì˜ˆ: 1ì¥ ì‹œì‘í•˜ê¸°", class: "w-full border border-gray-300 rounded p-2" %>
    </div>
      </div>
    </div>

    <!-- ìƒ‰ìƒ ì„ íƒ (ê·¸ë¦¬ë“œ ë°”ê¹¥) -->
    <div>
      <%= f.label :color, "ìƒ‰ìƒ", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <div class="flex space-x-4">
        <% [['#FFFFCD'], ['#E3FFDC'], ['#FFF0F8'], ['#E1FAFF']].each_with_index do |(hex), index| %>
          <label class="cursor-pointer">
            <%= f.radio_button :color, hex, id: "color_#{index}", class: "hidden peer", checked: @note.color.blank? && hex == "#FFFFCD" %>
            <span class="w-8 h-8 rounded-full border-2 border-gray-300 peer-checked:ring-2 ring-offset-2 ring-blue-500 inline-block" style="background-color: <%= hex %>"></span>
          </label>
        <% end %>
      </div>
    </div>

    <!-- ğŸ§  ë©”ëª¨ ì…ë ¥ ì˜ì—­ (ê·¸ë¦¬ë“œ ë°”ê¹¥, ì¤‘ì•™ ì •ë ¬, ë„ˆë¹„ ì œí•œ) -->
    <div class="space-y-6 w-full flex flex-col items-center mt-6">
     <div class="w-full max-w-[600px]">
  <%= f.label :memo, "ë©”ëª¨ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”", class: "block text-sm font-medium text-gray-700 mb-1" %>
  <%= f.text_area :memo, rows: 10, class: "block w-full border border-gray-300 rounded-md shadow-sm p-3 resize-none", id: "auto-resize-textarea" %>
</div>

      <div class="flex justify-end gap-4 w-full max-w-[600px]">
        <%= f.submit "ì €ì¥", class: "bg-[#644536] rounded text-white py-2 px-4 rounded-sm" %>
        <%= link_to "ì·¨ì†Œ", new_note_path, class: "rounded bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-sm flex items-center justify-center" %>
        <% if @note.persisted? %>
          <%= link_to "ì‚­ì œ", note_path(@note), method: :delete, data: { confirm: "ì •ë§ ì‚­ì œí• ê¹Œìš”?" }, class: "bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-sm flex items-center justify-center" %>
        <% end %>
      </div>
    </div>

  <% end %>
</div>

</main>

</div>
<!-- âœ… JS: ì±… ì„ íƒ â†’ ìƒˆ ì…ë ¥ë€ í‘œì‹œ + ëª©ì°¨ ë¡œë”© ë° ìƒˆë¡œìš´ ëª©ì°¨ ì…ë ¥ë€ í† ê¸€ -->
<script>
(function () {
  // ===== ì‘ì€ ìŠ¤ì¼ˆë ˆí†¤ (ì±•í„° ì˜ì—­/ë¡œë”©) =====
  const CHAPTER_SKELETON_HTML = `
    <div id="chapter-skeleton" class="animate-pulse" style="display:flex; gap:.5rem; margin:.25rem 0;">
      <div style="height:22px; width:140px; background:#eee; border-radius:6px;"></div>
      <div style="height:22px; width:90px; background:#eee; border-radius:6px;"></div>
    </div>
  `;
  function showChapterSkeleton(wrapper) {
    if (!wrapper || wrapper.querySelector("#chapter-skeleton")) return;
    const wrap = document.createElement("div");
    wrap.innerHTML = CHAPTER_SKELETON_HTML;
    wrapper.prepend(wrap.firstElementChild);
  }
  function hideChapterSkeleton(wrapper) {
    const sk = wrapper && wrapper.querySelector("#chapter-skeleton");
    if (sk) sk.remove();
  }

  // ===== ìœ í‹¸: ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€ =====
  function toggle(el, show) {
    if (!el) return;
    el.classList.toggle("hidden", !show);
  }

  // ===== í•µì‹¬ ë°”ì¸ë”© (í•œ í˜ì´ì§€ ë‚´ ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€) =====
  function initNoteForm() {
    // DOM ì¬ì¡°íšŒ (Turbo ì „í™˜ ëŒ€ë¹„)
    const bookSelect      = document.getElementById("book_select");
    const bookWrapper     = document.getElementById("book_select_wrapper");
    const newBookField    = document.getElementById("new_book_title_field");

    const chapterSelect   = document.getElementById("chapter_select");
    const chapterWrapper  = document.getElementById("chapter_select_wrapper");
    const newChapterField = document.getElementById("new_chapter_title_field");

    const chapterLabel    = document.getElementById("chapter_select_label");

    const pageFromField   = document.getElementById("page_from_field");

    // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
    if (!bookSelect) return;

    // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€ í”Œë˜ê·¸
    if (bookSelect.dataset.bound === "1") {
      // ë°”ì¸ë”©ì€ ë˜ì–´ìˆë”ë¼ë„, ì²« ë Œë”/ë³µê·€ ì‹œ ìƒíƒœ ë³´ì •ì€ í•´ì¤€ë‹¤
      applyInitialState();
      return;
    }
    bookSelect.dataset.bound = "1";

    // --- ìƒíƒœ í† ê¸€ í•¨ìˆ˜ë“¤ ---
    function toggleBookField() {
      const isNewBook = (bookSelect.value === "new_book");

      toggle(newBookField, isNewBook);
      toggle(bookWrapper, !isNewBook);

      if (isNewBook) {
        // ìƒˆ ì±… ì…ë ¥ì´ë©´ ì±•í„° ë“œë¡­ë‹¤ìš´ì€ ìˆ¨ê¸°ê³ , ìƒˆ ì±•í„° ì…ë ¥ í•„ë“œë§Œ ë³´ì—¬ì¤Œ
        toggle(chapterWrapper, false);
        toggle(chapterLabel, false);
        toggle(newChapterField, true);
      } else {
        // ê¸°ì¡´ ì±…ì´ë©´ ì±•í„° ë“œë¡­/ë¼ë²¨ì„ ë³´ì—¬ì£¼ê³ , ìƒˆ ì±•í„° ì…ë ¥ í•„ë“œëŠ” ìˆ¨ê¹€
        toggle(chapterWrapper, true);
        toggle(chapterLabel, true);
        toggle(newChapterField, false);
      }
    }

    function toggleChapterField() {
      if (!chapterSelect) return;
      const isNewChapter = (chapterSelect.value === "new_chapter");
      toggle(chapterSelect, !isNewChapter);
      toggle(newChapterField, isNewChapter);
      if (chapterLabel) chapterLabel.classList.toggle("hidden", isNewChapter);
    }

    // --- Ajax ë¡œ ì±•í„°/í˜„ì¬ í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸° ---
    async function loadChapters(bookId) {
      if (!bookId || bookId === "new_book") return;

      try {
        // ë¡œë”© ìŠ¤ì¼ˆë ˆí†¤
        showChapterSkeleton(chapterWrapper);

        const response = await fetch(`/books/${bookId}/chapters_and_current_page`, {
          headers: { "Accept": "application/json" }
        });
        if (!response.ok) throw new Error("Failed to fetch chapters");

        const data = await response.json();
        const chapters = Array.isArray(data.chapters) ? data.chapters : [];

        if (chapterSelect) {
          // ê¸°ì¡´ ì˜µì…˜ ì œê±°
          chapterSelect.innerHTML = "";
          // ì±•í„° ì±„ìš°ê¸°
          chapters.forEach(ch => {
            const option = document.createElement("option");
            option.value = ch.id;
            option.text  = ch.title;
            chapterSelect.appendChild(option);
          });
          // ìƒˆ ì±•í„° ì˜µì…˜
          const newOption = document.createElement("option");
          newOption.value = "new_chapter";
          newOption.text  = "â• ìƒˆë¡œìš´ ëª©ì°¨ ì…ë ¥";
          chapterSelect.appendChild(newOption);

          // ë“œë¡­ë‹¤ìš´/ë¼ë²¨ í‘œì‹œ, ìƒˆ ì±•í„° ì…ë ¥ ìˆ¨ê¹€
          toggle(chapterWrapper, true);
          chapterSelect.classList.remove("hidden");
          toggle(newChapterField, false);
          if (chapterLabel) chapterLabel.classList.remove("hidden");
        }

        // current_page + 1 â†’ page_from ìë™ ì…ë ¥
        if (pageFromField) {
          const currentPage = parseInt(data.current_page, 10);
          pageFromField.value = isNaN(currentPage) ? "" : (currentPage + 1);
        }
      } catch (err) {
        console.error("Ajax error:", err);
        if (chapterSelect) chapterSelect.innerHTML = "";
      } finally {
        hideChapterSkeleton(chapterWrapper);
      }
    }

    // --- ì´ë²¤íŠ¸ ë°”ì¸ë”© ---
    bookSelect.addEventListener("change", () => {
      toggleBookField();
      if (bookSelect.value && bookSelect.value !== "new_book") {
        loadChapters(bookSelect.value);
      }
    });

    if (chapterSelect && !chapterSelect.dataset.bound) {
      chapterSelect.dataset.bound = "1";
      chapterSelect.addEventListener("change", toggleChapterField);
    }

    // --- ì´ˆê¸° ìƒíƒœ ì ìš© ---
    function applyInitialState() {
      toggleBookField();

      // ê¸°ì¡´ ì±…ì´ ì„ íƒëœ ìƒíƒœë¼ë©´ ì±•í„°/í˜ì´ì§€ ì¦‰ì‹œ ë¡œë“œ
      if (bookSelect.value && bookSelect.value !== "new_book") {
        loadChapters(bookSelect.value);
      }

      // chapterSelectê°€ ì´ë¯¸ ë Œë”ë˜ì–´ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìƒíƒœ ë³´ì •
      toggleChapterField();
    }
    // ë‹¤ìŒ í”„ë ˆì„ì— ì´ˆê¸° ìƒíƒœ ì ìš©(ë ˆì´ì•„ì›ƒ ì•ˆì • í›„)
    requestAnimationFrame(applyInitialState);

    // --- í¼ ìœ íš¨ì„± ê²€ì‚¬ (í•´ë‹¹ í¼ 1ê°œì—ë§Œ ë°”ì¸ë”©) ---
    const form = bookSelect.closest("form") || document.querySelector("form");
    if (form && !form.dataset.bound) {
      form.dataset.bound = "1";
      form.addEventListener("submit", function (e) {
        const bookId   = bookSelect.value;
        const bookTitleInput = document.querySelector("input[name='note[book_title]']");
        const bookTitle = bookTitleInput ? bookTitleInput.value.trim() : "";

        const chapterId = chapterSelect ? chapterSelect.value : "";
        const chapterTitleInput = document.querySelector("input[name='note[chapter_title]']");
        const chapterTitle = chapterTitleInput ? chapterTitleInput.value.trim() : "";

        const memoEl = document.querySelector("textarea[name='note[memo]']");
        const memo   = memoEl ? memoEl.value.trim() : "";
        const pageTo   = (document.querySelector("input[name='note[page_to]']")   || {}).value;
        const pageFrom = (document.querySelector("input[name='note[page_from]']") || {}).value;

        if (bookId === "new_book" && bookTitle === "") {
          alert("ìƒˆ ì±… ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          e.preventDefault(); return;
        }
        if (!bookId) {
          alert("ì±…ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          e.preventDefault(); return;
        }
        if ((bookId !== "new_book") && (!chapterId || (chapterId === "new_chapter" && chapterTitle === ""))) {
          alert("ëª©ì°¨ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          e.preventDefault(); return;
        }
        if (memo === "") {
          alert("ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          e.preventDefault(); return;
        }
        if (!pageTo || isNaN(parseInt(pageTo, 10))) {
          alert("ë§ˆì§€ë§‰ ìª½ ìˆ˜(page_to)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          e.preventDefault(); return;
        }
        if (pageFrom && pageTo && parseInt(pageFrom, 10) > parseInt(pageTo, 10)) {
          alert("ì‹œì‘ ìª½ì€ ë ìª½ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.");
          e.preventDefault(); return;
        }
      });
    }

    // --- í…ìŠ¤íŠ¸ì—ì–´ë¦¬ì–´ ìë™ ë¦¬ì‚¬ì´ì¦ˆ (#auto-resize-textarea) ---
    const noteTextarea = document.getElementById("auto-resize-textarea");
    if (noteTextarea && !noteTextarea.dataset.bound) {
      noteTextarea.dataset.bound = "1";
      const resizeTextarea = () => {
        noteTextarea.style.height = "auto";
        noteTextarea.style.height = noteTextarea.scrollHeight + "px";
      };
      noteTextarea.addEventListener("input", resizeTextarea);
      requestAnimationFrame(resizeTextarea);
    }
  }

  // ===== Turbo ëŒ€ì‘: ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ì—ì„œ ë³´ì¥ =====
  function initAll() {
    initNoteForm();
  }
  document.addEventListener("DOMContentLoaded", initAll);
  document.addEventListener("turbo:load", initAll);
  document.addEventListener("turbo:render", initAll);
})();
</script>
