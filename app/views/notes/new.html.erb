<div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow space-y-6">
  <h2 class="text-xl font-bold text-gray-800">
    <%= @note.book&.title.presence || "ìƒˆë¡œìš´ ë©”ëª¨" %>
  </h2>

  <%= form_with(model: @note, local: true) do |f| %>

    <!-- ğŸ“˜ ì±… ì„ íƒ -->
<div id="book_select_wrapper" class="mb-4">
  <%= label_tag :book_id, "ì±… ì„ íƒ ë˜ëŠ” ìƒˆë¡œ ì…ë ¥", class: "block font-medium mb-1" %>
  <%= select_tag "note[book_id]",
      options_for_select(
        [["ğŸ“– ìƒˆë¡œìš´ ì±… ì…ë ¥", "new_book"]] + current_user.books.pluck(:title, :id),
        selected: @note.book_id
      ),
      prompt: "ì±…ì„ ì„ íƒí•˜ì„¸ìš”",
      class: "w-full border border-gray-300 rounded p-2",
      id: "book_select" %>
</div>


<!-- ìƒˆ ì±… ì œëª© ì…ë ¥ í•„ë“œ (ì´ˆê¸°ì—” ìˆ¨ê¹€) -->
<div id="new_book_title_field" class="mb-4 hidden">
  <%= label_tag "note[book_title]", "ìƒˆ ì±… ì œëª©", class: "block font-medium mb-1" %>
  <%= text_field_tag "note[book_title]", nil, placeholder: "ì˜ˆ: ë‚˜ë¯¸ì•¼ ì¡í™”ì ì˜ ê¸°ì ", class: "w-full border border-gray-300 rounded p-2" %>
</div>

  <%= f.label :chapter, "ë²”ìœ„", class: "block text-sm font-medium text-gray-700" %>
    <!-- âœï¸ í˜ì´ì§€, ëª©ì°¨, ìƒ‰ìƒ -->
    <div class="grid grid-cols-2 gap-4">
    
    <!-- âœ… ìª½ ë²”ìœ„ ì…ë ¥ í•œ ì¤„ì— í‘œì‹œ -->
<div class="flex items-center space-x-2">
  <%= f.number_field :page_from, class: "w-20 border border-gray-300 rounded-md p-2 text-sm" %>
  <span class="text-sm text-gray-700">ìª½ë¶€í„° ~ </span>
  <%= f.number_field :page_to, class: "w-20 border border-gray-300 rounded-md p-2 text-sm" %>
  <span class="text-sm text-gray-700">ìª½ê¹Œì§€</span>
</div>



<!-- ëª©ì°¨ ë“œë¡­ë‹¤ìš´ ì˜ì—­ -->
<!-- ëª©ì°¨ ë“œë¡­ë‹¤ìš´ ì˜ì—­ -->
<div id="chapter_select_wrapper" class="mb-4">
  <%= label_tag :chapter_id, "ëª©ì°¨ ì„ íƒ ë˜ëŠ” ìƒˆë¡œ ì…ë ¥", class: "block font-medium mb-1", id: "chapter_select_label" %>
  <%= select_tag "note[chapter_id]",
      options_for_select(
        (@chapters || []).map { |ch| [ch.title, ch.id] } + [["â• ìƒˆë¡œìš´ ëª©ì°¨ ì…ë ¥", "new_chapter"]],
        selected: @note.chapter_id
      ),
      prompt: "ëª©ì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”",
      class: "w-full border border-gray-300 rounded p-2",
      id: "chapter_select" %>
</div>

<!-- ìƒˆë¡œìš´ ëª©ì°¨ ì…ë ¥ë€ (ì´ˆê¸°ì—” ìˆ¨ê¹€) -->
<div id="new_chapter_title_field" class="mb-4 hidden">
  <%= label_tag "note[chapter_title]", "ìƒˆ ëª©ì°¨ ì œëª©", class: "block font-medium mb-1" %>
  <%= text_field_tag "note[chapter_title]", nil, placeholder: "ì˜ˆ: 1ì¥ ì‹œì‘í•˜ê¸°", class: "w-full border border-gray-300 rounded p-2" %>
</div>

<div class="col-span-2">
  <%= f.label :color, "ìƒ‰ìƒ", class: "block text-sm font-medium text-gray-700 mb-2" %>
  <div class="flex space-x-4">
    <% [['#FFFFCD'], ['#E3FFDC'], ['#FFF0F8'], ['#E1FAFF']].each_with_index do |(hex), index| %>
      <label class="cursor-pointer">
        <%= f.radio_button :color, hex, id: "color_#{index}", class: "hidden peer" %>
        <span class="w-8 h-8 rounded-full border-2 border-gray-300 peer-checked:ring-2 ring-offset-2 ring-blue-500 inline-block" style="background-color: <%= hex %>"></span>
      </label>
    <% end %>
  </div>
</div>

    <!-- ğŸ§  ë©”ëª¨ ì…ë ¥ -->
  <div class="space-y-6"> <!-- ì „ì²´ ì„¸ë¡œ ê°„ê²© -->
  <div>
    <%= f.label :memo, "ë©”ëª¨ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”", class: "block text-sm font-medium text-gray-700" %>
   <%= f.text_area :memo, rows: 10, class: "mt-1 block w-[600px] border border-gray-300 rounded-md shadow-sm p-3 resize-y" %>

  </div>

  <div class="flex justify-center gap-4">
    <%= f.submit "ì €ì¥", class: "bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-xl" %>
    <%= link_to "ì·¨ì†Œ", new_note_path, class: "bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-xl flex items-center justify-center" %>
    <% if @note.persisted? %>
      <%= link_to "ì‚­ì œ", note_path(@note), method: :delete, data: { confirm: "ì •ë§ ì‚­ì œí• ê¹Œìš”?" }, class: "bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-xl flex items-center justify-center" %>
    <% end %>
  </div>
</div>

  <% end %>
</div>
<!-- âœ… JS: ì±… ì„ íƒ â†’ ìƒˆ ì…ë ¥ë€ í‘œì‹œ + ëª©ì°¨ ë¡œë”© ë° ìƒˆë¡œìš´ ëª©ì°¨ ì…ë ¥ë€ í† ê¸€ -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // DOM ìš”ì†Œ
  const bookSelect = document.getElementById("book_select");
  const bookWrapper = document.getElementById("book_select_wrapper");
  const newBookField = document.getElementById("new_book_title_field");

  const chapterSelect = document.getElementById("chapter_select");
  const chapterWrapper = document.getElementById("chapter_select_wrapper");
  const newChapterField = document.getElementById("new_chapter_title_field");

  // ìƒˆë¡œ ì¶”ê°€í•œ ëª©ì°¨ ë¼ë²¨ id
  const chapterLabel = document.getElementById("chapter_select_label");

  // 1) ì±… ì„ íƒ ìƒíƒœ í† ê¸€ í•¨ìˆ˜
  function toggleBookField() {
    const isNewBook = bookSelect.value === "new_book";

    newBookField.classList.toggle("hidden", !isNewBook);
  bookWrapper.classList.toggle("hidden", isNewBook);

  if (isNewBook) {
    // ìƒˆ ì±… ì…ë ¥ ì‹œ
    chapterWrapper.classList.add("hidden");       // ëª©ì°¨ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¹€
    chapterLabel.classList.add("hidden");         // ëª©ì°¨ ë¼ë²¨ ìˆ¨ê¹€
    newChapterField.classList.remove("hidden");   // ìƒˆ ëª©ì°¨ ì…ë ¥ í•„ë“œ ë³´ì„
  } else {
    // ì±… ì„ íƒ ì‹œ
    chapterWrapper.classList.remove("hidden");    // ëª©ì°¨ ë“œë¡­ë‹¤ìš´ ë³´ì„
    chapterLabel.classList.remove("hidden");      // ëª©ì°¨ ë¼ë²¨ ë³´ì„
    newChapterField.classList.add("hidden");      // ìƒˆ ëª©ì°¨ ì…ë ¥ í•„ë“œ ìˆ¨ê¹€
  }
  }

  // 2) ëª©ì°¨ ì„ íƒ ìƒíƒœ í† ê¸€ í•¨ìˆ˜ (ë¼ë²¨ë„ ê°™ì´ í† ê¸€)
  function toggleChapterField() {
    const isNewChapter = chapterSelect.value === "new_chapter";

    chapterSelect.classList.toggle("hidden", isNewChapter);
    newChapterField.classList.toggle("hidden", !isNewChapter);

    if (chapterLabel) {
      chapterLabel.classList.toggle("hidden", isNewChapter);
    }
  }

  // 3) ì±… ì„ íƒì‹œ ëª©ì°¨ ë°ì´í„° AJAXë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadChapters(bookId) {
    if (!bookId || bookId === "new_book") return;

    try {
      const response = await fetch(`/books/${bookId}/chapters`);
      if (!response.ok) throw new Error("Failed to fetch chapters");
      const chapters = await response.json();

      chapterSelect.innerHTML = "";

      chapters.forEach(ch => {
        const option = document.createElement("option");
        option.value = ch.id;
        option.text = ch.title;
        chapterSelect.appendChild(option);
      });

      const newOption = document.createElement("option");
      newOption.value = "new_chapter";
      newOption.text = "â• ìƒˆë¡œìš´ ëª©ì°¨ ì…ë ¥";
      chapterSelect.appendChild(newOption);

      chapterWrapper.classList.remove("hidden");
      newChapterField.classList.add("hidden");

      // ë¼ë²¨ë„ ë³´ì´ê²Œ
      if (chapterLabel) {
        chapterLabel.classList.remove("hidden");
      }
    } catch (error) {
      console.error(error);
      chapterSelect.innerHTML = "";
    }
  }

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  bookSelect.addEventListener("change", () => {
    toggleBookField();

    if (bookSelect.value && bookSelect.value !== "new_book") {
      loadChapters(bookSelect.value);
    }
  });

  chapterSelect.addEventListener("change", toggleChapterField);

  // ì´ˆê¸° ë¡œë”© ì‹œ ìƒíƒœ ë°˜ì˜
  toggleBookField();

  if (bookSelect.value && bookSelect.value !== "new_book") {
    loadChapters(bookSelect.value);
  }

  toggleChapterField();
});


</script>
