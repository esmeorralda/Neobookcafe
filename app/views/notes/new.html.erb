<!-- ì „ì²´ ë°°ê²½ -->
<div class="min-h-screen bg-[#f7f1ea] flex flex-col">

  <!-- ìƒë‹¨ ì—¬ë°± ì œê±° -->
  <main class="flex-1">
<div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow space-y-6 mt-5">

  <h2 class="text-xl font-bold text-gray-800">
    <% if @note&.book.present? %>
      <%= @note.book.title %>
    <% elsif @note&.book_id == "new_book" %>
      <%= params[:note][:book_title].presence || "ìƒˆë¡œìš´ ë©”ëª¨" %>
    <% else %>
      ìƒˆë¡œìš´ ë©”ëª¨
    <% end %>
  </h2>

  <%= form_with(model: @note, local: true) do |f| %>

    <!-- ğŸ“˜ ì±… ì„ íƒ -->
    <div id="book_select_wrapper" class="mb-4">
      <%= label_tag :book_id, "ì±… ì„ íƒ ë˜ëŠ” ìƒˆë¡œ ì…ë ¥", class: "block font-medium mb-1" %>
      <%= select_tag "note[book_id]",
          options_for_select(
            [["ğŸ“– ìƒˆë¡œìš´ ì±… ì…ë ¥", "new_book"]] + current_user.books.pluck(:title, :id),
            selected: @note.book_id
          ),
          prompt: "ì±…ì„ ì„ íƒí•˜ì„¸ìš”",
          class: "w-full border border-gray-300 rounded p-2",
          id: "book_select" %>
    </div>

    <!-- ìƒˆ ì±… ì œëª© ì…ë ¥ í•„ë“œ (ì´ˆê¸°ì—” ìˆ¨ê¹€) -->
    <div id="new_book_title_field" class="mb-4 hidden">
      <%= label_tag "note[book_title]", "ìƒˆ ì±… ì œëª©", class: "block font-medium mb-1" %>
      <%= text_field_tag "note[book_title]", nil, placeholder: "ì˜ˆ: ë‚˜ë¯¸ì•¼ ì¡í™”ì ì˜ ê¸°ì ", class: "w-full border border-gray-300 rounded p-2" %>
    </div>

   

    <!-- ìª½ìˆ˜ì™€ ëª©ì°¨ ì˜ì—­ë§Œ ê·¸ë¦¬ë“œ -->
    <!-- ìƒˆ ì±… ì œëª© ì…ë ¥ í•„ë“œ (ì´ˆê¸°ì—” ìˆ¨ê¹€) -->
   <div class="flex items-center space-x-6"> <!-- items-centerë¡œ ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ -->
   

    <div class="flex flex-col space-y-2">
     <label for="page_from_field " class="block font-medium mb-1 text-sm text-gray-700 leading-6">ë²”ìœ„</label> <!-- í°íŠ¸ í¬ê¸°, ì¤„ë†’ì´ ë™ì¼í•˜ê²Œ -->
      <div class="flex items-center space-x-2 mb-2">
     
        <%= f.number_field :page_from, id: "page_from_field", class: "w-20 border border-gray-300 rounded-md p-2 text-sm" %>
      <span class="text-sm text-gray-700 leading-6">ìª½ë¶€í„° ~ </span>
      <%= f.number_field :page_to, class: "w-20 border border-gray-300 rounded-md p-2 text-sm" %>
      <span class="text-sm text-gray-700 leading-6">ìª½ê¹Œì§€</span>
      </div>
      </div>


      <!-- ëª©ì°¨ ë“œë¡­ë‹¤ìš´ ì˜ì—­ -->
      <div  class="flex flex-col flex-1 space-y-2" id="chapter_select_wrapper">
         <%= label_tag :chapter_id, "ëª©ì°¨ ì„ íƒ ë˜ëŠ” ìƒˆë¡œ ì…ë ¥", class: "block font-medium mb-1 text-sm text-gray-700 leading-6", id: "chapter_select_label" %>  
       <%= select_tag "note[chapter_id]",
        options_for_select(
          (@chapters || []).map { |ch| [ch.title, ch.id] } + [["â• ìƒˆë¡œìš´ ëª©ì°¨ ì…ë ¥", "new_chapter"]],
          selected: @note.chapter_id
        ),
        prompt: "ëª©ì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”",
        class: "w-full border border-gray-300 rounded p-2",
        id: "chapter_select" %>

    <div id="new_chapter_title_field" class="mt-2 hidden">
      <%= label_tag "note[chapter_title]", "ìƒˆ ëª©ì°¨ ì œëª©", class: "block font-medium mb-1 text-sm text-gray-700 leading-6" %>
      <%= text_field_tag "note[chapter_title]", nil, placeholder: "ì˜ˆ: 1ì¥ ì‹œì‘í•˜ê¸°", class: "w-full border border-gray-300 rounded p-2" %>
    </div>
      </div>
    </div>

    <!-- ìƒ‰ìƒ ì„ íƒ (ê·¸ë¦¬ë“œ ë°”ê¹¥) -->
    <div>
      <%= f.label :color, "ìƒ‰ìƒ", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <div class="flex space-x-4">
        <% [['#FFFFCD'], ['#E3FFDC'], ['#FFF0F8'], ['#E1FAFF']].each_with_index do |(hex), index| %>
          <label class="cursor-pointer">
            <%= f.radio_button :color, hex, id: "color_#{index}", class: "hidden peer", checked: @note.color.blank? && hex == "#FFFFCD" %>
            <span class="w-8 h-8 rounded-full border-2 border-gray-300 peer-checked:ring-2 ring-offset-2 ring-blue-500 inline-block" style="background-color: <%= hex %>"></span>
          </label>
        <% end %>
      </div>
    </div>

    <!-- ğŸ§  ë©”ëª¨ ì…ë ¥ ì˜ì—­ (ê·¸ë¦¬ë“œ ë°”ê¹¥, ì¤‘ì•™ ì •ë ¬, ë„ˆë¹„ ì œí•œ) -->
    <div class="space-y-6 w-full flex flex-col items-center mt-6">
     <div class="w-full max-w-[600px]">
  <%= f.label :memo, "ë©”ëª¨ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”", class: "block text-sm font-medium text-gray-700 mb-1" %>
  <%= f.text_area :memo, rows: 10, class: "block w-full border border-gray-300 rounded-md shadow-sm p-3 resize-none", id: "auto-resize-textarea" %>
</div>

      <div class="flex justify-end gap-4 w-full max-w-[600px]">
        <%= f.submit "ì €ì¥", class: "bg-[#644536] rounded text-white py-2 px-4 rounded-sm" %>
        <%= link_to "ì·¨ì†Œ", new_note_path, class: "rounded bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-sm flex items-center justify-center" %>
        <% if @note.persisted? %>
          <%= link_to "ì‚­ì œ", note_path(@note), method: :delete, data: { confirm: "ì •ë§ ì‚­ì œí• ê¹Œìš”?" }, class: "bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-sm flex items-center justify-center" %>
        <% end %>
      </div>
    </div>

  <% end %>
</div>

</main>

</div>
<!-- âœ… JS: ì±… ì„ íƒ â†’ ìƒˆ ì…ë ¥ë€ í‘œì‹œ + ëª©ì°¨ ë¡œë”© ë° ìƒˆë¡œìš´ ëª©ì°¨ ì…ë ¥ë€ í† ê¸€ -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // DOM ìš”ì†Œë“¤
  const bookSelect = document.getElementById("book_select");
  const bookWrapper = document.getElementById("book_select_wrapper");
  const newBookField = document.getElementById("new_book_title_field");

  const chapterSelect = document.getElementById("chapter_select");
  const chapterWrapper = document.getElementById("chapter_select_wrapper");
  const newChapterField = document.getElementById("new_chapter_title_field");

  const chapterLabel = document.getElementById("chapter_select_label");

  // ì±… ì„ íƒ ìƒíƒœì— ë”°ë¼ ìƒˆ ì±… ì…ë ¥ í•„ë“œ ë° ëª©ì°¨ ì…ë ¥ í•„ë“œ í† ê¸€
  function toggleBookField() {
    const isNewBook = bookSelect.value === "new_book";

    newBookField.classList.toggle("hidden", !isNewBook);
    bookWrapper.classList.toggle("hidden", isNewBook);

    if (isNewBook) {
      chapterWrapper.classList.add("hidden");
      chapterLabel.classList.add("hidden");
      newChapterField.classList.remove("hidden");
    } else {
      chapterWrapper.classList.remove("hidden");
      chapterLabel.classList.remove("hidden");
      newChapterField.classList.add("hidden");
    }
  }

  // ëª©ì°¨ ë“œë¡­ë°•ìŠ¤ or ì…ë ¥ í•„ë“œ í† ê¸€
  function toggleChapterField() {
    const isNewChapter = chapterSelect.value === "new_chapter";

    chapterSelect.classList.toggle("hidden", isNewChapter);
    newChapterField.classList.toggle("hidden", !isNewChapter);

    if (chapterLabel) {
      chapterLabel.classList.toggle("hidden", isNewChapter);
    }
  }

  // ğŸ“˜ ì±… ì„ íƒ ì‹œ ëª©ì°¨ì™€ current_page ê°€ì ¸ì˜¤ëŠ” Ajax
  async function loadChapters(bookId) {
    if (!bookId || bookId === "new_book") return;

    try {
      const response = await fetch(`/books/${bookId}/chapters_and_current_page`);
      if (!response.ok) throw new Error("Failed to fetch chapters");

      const data = await response.json();
      const chapters = data.chapters;

      // ëª©ì°¨ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
      chapterSelect.innerHTML = "";
      chapters.forEach(ch => {
        const option = document.createElement("option");
        option.value = ch.id;
        option.text = ch.title;
        chapterSelect.appendChild(option);
      });

      const newOption = document.createElement("option");
      newOption.value = "new_chapter";
      newOption.text = "â• ìƒˆë¡œìš´ ëª©ì°¨ ì…ë ¥";
      chapterSelect.appendChild(newOption);

      chapterWrapper.classList.remove("hidden");
      chapterSelect.classList.remove("hidden");
      newChapterField.classList.add("hidden");

      if (chapterLabel) {
        chapterLabel.classList.remove("hidden");
      }

      // current_page + 1 â†’ page_from í•„ë“œì— ìë™ ì…ë ¥
      const pageFromField = document.getElementById("page_from_field");
      if (pageFromField) {
        const currentPage = parseInt(data.current_page, 10);
        pageFromField.value = isNaN(currentPage) ? 0 : currentPage + 1;
      }
    } catch (error) {
      console.error("Ajax error:", error);
      chapterSelect.innerHTML = "";


    }
  }

  // ğŸ“Œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  bookSelect.addEventListener("change", () => {
    toggleBookField();

    if (bookSelect.value && bookSelect.value !== "new_book") {
      loadChapters(bookSelect.value);
    }
  });

  if (chapterSelect) {
    chapterSelect.addEventListener("change", toggleChapterField);
  }

  // ì´ˆê¸° ë¡œë”© ì‹œ ìƒíƒœ ë°˜ì˜
  toggleBookField();
  if (bookSelect.value && bookSelect.value !== "new_book") {
    loadChapters(bookSelect.value);
  }
  toggleChapterField();

  // ğŸ“‹ í¼ ìœ íš¨ì„± ê²€ì‚¬
  const form = document.querySelector("form");

  form.addEventListener("submit", function (e) {
    const bookId = bookSelect.value;
    const bookTitle = document.querySelector("input[name='note[book_title]']").value.trim();

    const chapterId = chapterSelect ? chapterSelect.value : "";
    const chapterTitleInput = document.querySelector("input[name='note[chapter_title]']");
    const chapterTitle = chapterTitleInput ? chapterTitleInput.value.trim() : "";

    const memo = document.querySelector("textarea[name='note[memo]']").value.trim();
    const pageTo = document.querySelector("input[name='note[page_to]']").value;
    const pageFrom = document.querySelector("input[name='note[page_from]']").value;

    if (bookId === "new_book" && bookTitle === "") {
      alert("ìƒˆ ì±… ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      e.preventDefault();
      return;
    }

    if (!bookId) {
      alert("ì±…ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      e.preventDefault();
      return;
    }

    if ((bookId !== "new_book") && (!chapterId || (chapterId === "new_chapter" && chapterTitle === ""))) {
      alert("ëª©ì°¨ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      e.preventDefault();
      return;
    }

    if (memo === "") {
      alert("ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      e.preventDefault();
      return;
    }

    if (!pageTo || isNaN(parseInt(pageTo))) {
      alert("ë§ˆì§€ë§‰ ìª½ ìˆ˜(page_to)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      e.preventDefault();
      return;
    }

    if (pageFrom && pageTo && parseInt(pageFrom) > parseInt(pageTo)) {
      alert("ì‹œì‘ ìª½ì€ ë ìª½ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.");
      e.preventDefault();
      return;
    }
  });
});

document.addEventListener("DOMContentLoaded", function () {
    const textarea = document.getElementById("auto-resize-textarea");

    function resizeTextarea() {
      textarea.style.height = "auto";  // ì´ˆê¸°í™”
      textarea.style.height = (textarea.scrollHeight) + "px";  // ì½˜í…ì¸  ë†’ì´ë§Œí¼ ì„¤ì •
    }

    if (textarea) {
      textarea.addEventListener("input", resizeTextarea);
      resizeTextarea();  // ì´ˆê¸° ë¡œë”© ì‹œì—ë„ ì¡°ì ˆ
    }
  });
</script>
