<!DOCTYPE html>
<html>

  <head>
    <%# <%= favicon_link_tag 'favicon.png'  %>
    <%= favicon_link_tag 'favicon.svg', rel: 'icon', type: 'image/svg+xml' %>
   <%= javascript_importmap_tags %> 



    <title>NeoBookCafe</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
<!-- Noto Serif KR -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">

    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
    <%= javascript_importmap_tags %>
  </head>

  <body>
    <header class="site-header">
      <div class="header-container">
        <%# <div class="logo">
          <%= image_tag "logo.svg", alt: "NeoBookCafe Logo", class: "logo" %>
          <%# <span class="brand">BookCafe</span>
        </div> %> 
  <%= link_to root_path, class: "logo flex items-center space-x-2" do %>
  <%= image_tag "logo.svg", alt: "NeoBookCafe Logo", class: "logo" %>
  <span class="brand">BookCafe</span>
<% end %>

      <%= form_with url: search_path, method: :get, class: "search-box", data: { turbo: false } do |f| %>
  <%= f.text_field :q, 
      value: params[:q], 
      placeholder: "책 제목, 저자, 글 제목, 글 저자...", 
      class: "search-input" %>
  <%= f.button "🔍", 
      type: "submit", 
      class: "search-btn",
      name: nil %>
<% end %>


   <div class="nav-links">
  <% if user_signed_in? %>
  <!-- 헤더 영역에 알림 버튼 -->
<button id="toggle-notification" class="text-[14px] text-[#333] no-underline ml-4">
  🔔
</button>
    <button id="toggle-right-sidebar" class="text-[14px] text-[#333] no-underline">프로필</button>
<%= link_to "설정", "#", class: "open-settings-modal text-sm underline", data: { url: settings_path } %>


      <%= link_to "로그아웃", destroy_user_session_path, method: :delete, data: { turbo_method: :delete }, class: "text-[14px] text-[#333] no-underline" %>
  <% else %>
    <%= link_to "로그인", new_user_session_path %>
  <% end %>
</div>



         <%# <button onclick="openModal()" class="bg-blue-600 px-4 py-2">
            로그인
          </button> %>
      </div>
   <div id="test-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center"
     style="top: 50%; left: 50%; transform: translate(-50%, -50%);">
  <div class="bg-white p-6 rounded shadow-lg max-w-6xl w-full max-h-[90vh] overflow-auto border border-gray-300">

    <h2 class="text-2xl font-bold mb-6">설정</h2>

    <!-- 탭 버튼 -->
    <nav class="flex border-b border-gray-300 mb-6" id="modal-tabs">
      <button class="tab-btn px-4 py-2 border-b-2 border-[#3e2f23] font-semibold focus:outline-none" data-tab="0">알림</button>
      <button class="tab-btn px-4 py-2 border-b-2 border-transparent hover:border-gray-400 focus:outline-none ml-6" data-tab="1">글자</button>
      <button class="tab-btn px-4 py-2 border-b-2 border-transparent hover:border-gray-400 focus:outline-none ml-6" data-tab="2">언어</button>
      <button class="tab-btn px-4 py-2 border-b-2 border-transparent hover:border-gray-400 focus:outline-none ml-6" data-tab="3">비밀번호 변경</button>
    </nav>

    <!-- 탭 내용 -->
    <div id="tab-contents">
      <section class="tab-content">
        <h3 class="text-xl font-semibold mb-3">알림 설정</h3>
        <label class="inline-flex items-center mt-1">
          <input type="checkbox" class="form-checkbox" />
          <span class="ml-2">이메일 알림 받기</span>
        </label>

        <div class="flex justify-center gap-6 mt-6">
          <button class="bg-[#3e2f23] text-white py-2 px-6 rounded hover:bg-[#5b4633]">적용하기</button>
          <button id="close-modal-btn" class="bg-gray-300 py-2 px-6 rounded hover:bg-gray-400">닫기</button>
        </div>
      </section>

 <section class="tab-content hidden">
  <h3 class="text-xl font-semibold mb-3">글자 설정</h3>
  <label class="block mt-2">
    <span class="text-sm font-medium mb-1 block">글자 크기 조절</span>
    <input type="range" id="font-size-slider" min="13" max="19" value="16" class="w-full" />
  </label>

  <div class="flex justify-center gap-6 mt-6">
    <button id="close-modal-btn-2" class="bg-gray-300 py-2 px-6 rounded hover:bg-gray-400">닫기</button>
  </div>
</section>

      <section class="tab-content hidden">
        <h3 class="text-xl font-semibold mb-3">언어 설정</h3>
        <label for="language-select" class="block text-sm mb-1">언어 선택</label>
        <select id="language-select" class="w-full border border-gray-300 rounded px-3 py-2">
          <option value="ko">한국어 (Korean)</option>
          <option value="en">English</option>
        </select>

        <div class="flex justify-center gap-6 mt-6">
          <button class="bg-[#3e2f23] text-white py-2 px-6 rounded hover:bg-[#5b4633]">적용하기</button>
          <button id="close-modal-btn-3" class="bg-gray-300 py-2 px-6 rounded hover:bg-gray-400">닫기</button>
        </div>
      </section>

      <section class="tab-content hidden">
        <h3 class="text-xl font-semibold mb-3">비밀번호 변경</h3>
       <% if user_signed_in? %>
<% resource = current_user %>
<% resource_name = :user %>
<% devise_mapping = Devise.mappings[:user] %>
<% @minimum_password_length = Devise.password_length.min %>

<%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put }) do |f| %>
  <div class="mb-6">
    <%= f.label :current_password, "현재 비밀번호 (변경 사항 확인용)", class: "block text-sm font-medium mb-1" %>
    <%= f.password_field :current_password, autocomplete: "current-password", class: "w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-[#3e2f23]" %>
  </div>

  <div class="mb-6">
    <%= f.label :password, "새 비밀번호 (변경하지 않으려면 비워두세요)", class: "block text-sm font-medium mb-1" %>
    <%= f.password_field :password, autocomplete: "new-password", class: "w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-[#3e2f23]" %>
    <% if @minimum_password_length %>
      <p class="text-xs mt-1 text-gray-500">최소 <%= @minimum_password_length %>자 이상</p>
    <% end %>
  </div>

  <div class="mb-6">
    <%= f.label :password_confirmation, "새 비밀번호 확인", class: "block text-sm font-medium mb-1" %>
    <%= f.password_field :password_confirmation, autocomplete: "new-password", class: "w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-[#3e2f23]" %>
  </div>

  <div class="flex justify-center gap-6 mt-6">
    <%= f.submit "적용하기", class: "bg-[#3e2f23] text-white py-2 px-6 rounded hover:bg-[#5b4633]" %>
    <button type="button" id="close-modal-btn-4" class="bg-gray-300 py-2 px-6 rounded hover:bg-gray-400">닫기</button>
  </div>
<% end %>
<% end %>
      </section>
    </div>

  </div>
</div>
<% if @show_sidebar %>
<div class="bg-[#f3ede3] pt-1 text-sm text-[#7c6243] flex justify-center space-x-8 relative">
  <% if params[:category] == "creation" %>
    <%= link_to "전체", posts_path(category: :creation),
        class: "pb-1 border-b-2 hover:border-[#7c6243] #{params[:book_genre].blank? ? 'border-[#7c6243]' : 'border-transparent'}" %>
    <%= link_to "시", posts_path(category: :creation, book_genre: :poetry),
        class: "pb-1 border-b-2 hover:border-[#7c6243] #{params[:book_genre] == 'poetry' ? 'border-[#7c6243]' : 'border-transparent'}" %>
    <%= link_to "에세이", posts_path(category: :creation, book_genre: :essay),
        class: "pb-1 border-b-2 hover:border-[#7c6243] #{params[:book_genre] == 'essay' ? 'border-[#7c6243]' : 'border-transparent'}" %>
    <%= link_to "소설", posts_path(category: :creation, book_genre: :novel),
        class: "pb-1 border-b-2 hover:border-[#7c6243] #{params[:book_genre] == 'novel' ? 'border-[#7c6243]' : 'border-transparent'}" %>
  <% else %>
    <%= link_to "전체", posts_path(category: params[:category]),
        class: "pb-1 border-b-2 hover:border-[#7c6243] #{params[:book_genre].blank? ? 'border-[#7c6243]' : 'border-transparent'}" %>
    <%= link_to "철학", posts_path(category: params[:category], book_genre: :philosophy),
        class: "pb-1 border-b-2 hover:border-[#7c6243] #{params[:book_genre] == 'philosophy' ? 'border-[#7c6243]' : 'border-transparent'}" %>
    <%= link_to "문학", posts_path(category: params[:category], book_genre: :literature),
        class: "pb-1 border-b-2 hover:border-[#7c6243] #{params[:book_genre] == 'literature' ? 'border-[#7c6243]' : 'border-transparent'}" %>
    <%= link_to "역사", posts_path(category: params[:category], book_genre: :history),
        class: "pb-1 border-b-2 hover:border-[#7c6243] #{params[:book_genre] == 'history' ? 'border-[#7c6243]' : 'border-transparent'}" %>
    <%= link_to "사회", posts_path(category: params[:category], book_genre: :society),
        class: "pb-1 border-b-2 hover:border-[#7c6243] #{params[:book_genre] == 'society' ? 'border-[#7c6243]' : 'border-transparent'}" %>
    <%= link_to "경제", posts_path(category: params[:category], book_genre: :economy),
        class: "pb-1 border-b-2 hover:border-[#7c6243] #{params[:book_genre] == 'economy' ? 'border-[#7c6243]' : 'border-transparent'}" %>
    <%= link_to "과학/기술", posts_path(category: params[:category], book_genre: :science_technology),
        class: "pb-1 border-b-2 hover:border-[#7c6243] #{params[:book_genre] == 'science_technology' ? 'border-[#7c6243]' : 'border-transparent'}" %>
  <% end %>
</div>

<% end %>

<% if user_signed_in? %>
<div id="notification-panel" class="hidden fixed right-0 top-12 w-64 h-[calc(100vh-4rem)] bg-white shadow-lg border-l border-gray-200 z-50 overflow-y-auto">
  <div class="px-4 py-4">
    <h3 class="text-base font-semibold text-[#3e2f23] mb-3">알림</h3>

    <% if current_user.notifications.any? %>
      <ul class="space-y-3">
        <% current_user.notifications.order(created_at: :desc).limit(10).each do |notification| %>
          <% if notification.notifiable_type == "Comment" %>
            <% comment = Comment.find_by(id: notification.notifiable_id) %>
            <% if comment && comment.post %>
              <li class="text-sm text-gray-700 border-b border-gray-100 pb-2">
                <%= notification.message %>
                <div class="mt-1 text-xs text-gray-500">
                  <%= truncate(comment.content, length: 50) %>
                </div>
                <div class="flex justify-between items-center mt-1">
                  <span class="text-xs text-gray-400">
                    <%= time_ago_in_words(notification.created_at) %> 전
                  </span>
                  <%= link_to "글로 이동", post_path(comment.post, anchor: "comment-#{comment.id}"),
                        class: "text-blue-500 text-xs hover:underline" %>
                </div>
              </li>
            <% end %>
          <% else %>
            <li class="text-sm text-gray-700 border-b border-gray-100 pb-2">
              <%= notification.message %>
              <div class="flex justify-between items-center mt-1">
                <span class="text-xs text-gray-400">
                  <%= time_ago_in_words(notification.created_at) %> 전
                </span>
              </div>
            </li>
          <% end %>
        <% end %>
      </ul>
    <% else %>
      <p class="text-sm text-gray-500">새로운 알림이 없습니다.</p>
    <% end %>
  </div>
</div>

<%end %>
    </header>



    <%= render 'layouts/sidebar' %>

   <main class="main-content h-[calc(100vh-4rem)] overflow-auto mt-15">
  <%= yield %>
</main>



<div id="right-sidebar" class="hidden fixed top-16 right-0 h-[calc(100vh-4rem)] w-64 bg-[#f0ece3] text-[#7c6243] shadow-lg z-50">

     <%= render 'layouts/right_sidebar' %>

     <% if flash[:alert] %>
    <div class="alert alert-danger">
      <pre><%= flash[:alert] %></pre>
    </div>
  <% end %>

  <%= yield %>

</div>





  </body>

</html>

<% if user_signed_in? %>
<script>
document.addEventListener("DOMContentLoaded", () => {
  initNotificationPanel();
  initPasswordValidation();
  initSettingsModal();
  initFontSizeSlider();
});

function initNotificationPanel() {
  const toggleBtn = document.getElementById("toggle-notification");
  const panel = document.getElementById("notification-panel");
  if (!toggleBtn || !panel) return;

  toggleBtn.addEventListener("click", () => {
    panel.classList.toggle("hidden");
  });

  document.addEventListener("click", (e) => {
    if (!panel.contains(e.target) && !toggleBtn.contains(e.target)) {
      panel.classList.add("hidden");
    }
  });
}

function initPasswordValidation() {
  const form = document.querySelector("form");
  if (!form) return;

  const currentPasswordInput = form.querySelector("[name='user[current_password]']");
  const newPasswordInput = form.querySelector("[name='user[password]']");
  const confirmPasswordInput = form.querySelector("[name='user[password_confirmation]']");
  const submitBtn = document.getElementById("password-submit");

  if (!currentPasswordInput || !newPasswordInput || !confirmPasswordInput || !submitBtn) return;

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const currentPassword = currentPasswordInput.value.trim();
    const newPassword = newPasswordInput.value.trim();
    const confirmPassword = confirmPasswordInput.value.trim();

    if (!currentPassword) {
      alert("현재 비밀번호를 입력하세요.");
      currentPasswordInput.focus();
      return;
    }

    if (newPassword || confirmPassword) {
      if (newPassword.length < 6) {
        alert("새 비밀번호는 최소 6자 이상이어야 합니다.");
        newPasswordInput.focus();
        return;
      }
      if (newPassword !== confirmPassword) {
        alert("새 비밀번호와 확인용 비밀번호가 일치하지 않습니다.");
        confirmPasswordInput.focus();
        return;
      }
      if (newPassword === currentPassword) {
        alert("새 비밀번호는 현재 비밀번호와 달라야 합니다.");
        newPasswordInput.focus();
        return;
      }
    }

    form.submit();
  });

  document.getElementById("close-modal-btn-4")?.addEventListener("click", () => {
    document.getElementById("test-modal")?.classList.add("hidden");
  });
}

function initSettingsModal() {
  const modal = document.getElementById("test-modal");
  if (!modal) return;

  const openBtns = document.querySelectorAll(".open-settings-modal");
  const closeBtns = modal.querySelectorAll("button[id^='close-modal-btn']");
  const tabs = modal.querySelectorAll(".tab-btn");
  const tabContents = modal.querySelectorAll(".tab-content");

  openBtns.forEach(btn => {
    btn.addEventListener("click", e => {
      e.preventDefault();
      modal.classList.remove("hidden");
      showTab(0);
    });
  });

  closeBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      modal.classList.add("hidden");
    });
  });

  tabs.forEach((tab, i) => {
    tab.addEventListener("click", () => {
      showTab(i);
    });
  });

  function showTab(index) {
    tabs.forEach((tab, i) => {
      tab.classList.toggle("border-[#3e2f23]", i === index);
      tab.classList.toggle("font-semibold", i === index);
      tab.classList.toggle("border-transparent", i !== index);
    });

    tabContents.forEach((content, i) => {
      content.classList.toggle("hidden", i !== index);
    });
  }
}

function initFontSizeSlider() {
  const slider = document.getElementById("font-size-slider");
  const applyBtn = document.getElementById("apply-font-size");
  if (!slider) return;

  const savedFontSize = localStorage.getItem("fontSize");
  if (savedFontSize) {
    document.documentElement.style.fontSize = savedFontSize;
    slider.value = parseInt(savedFontSize);
  }

  slider.addEventListener("input", () => {
    const fontSize = slider.value + "px";
    document.documentElement.style.fontSize = fontSize;
    localStorage.setItem("fontSize", fontSize);
  });

  applyBtn?.addEventListener("click", () => {
    const fontSize = slider.value + "px";
    document.documentElement.style.fontSize = fontSize;
    localStorage.setItem("fontSize", fontSize);
  });
}
</script>


<% if notice.present? %>
  <script>
    alert("<%= j(notice) %>");
  </script>
<% end %>

<% if alert.present? %>
  <script>
    alert("<%= j(alert) %>");
  </script>
<% end %>

<% end %>
